{{!< layout/default}}

{{#extend "css"}}
<style>
.info-box {
    box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    border-radius: .25rem;
    padding: .5rem;
    min-height: 80px;
    background: #fff;
    display: flex!important; 
    margin-top:10px;
    font-size: 20px;
}
.info-box-icon {
    border-radius: .25rem;
    display: block;
    width: 90px;
    text-align: center;
    font-size: 40px;
    color: #fff!important;
}
.btn-warning:disabled {
    color: #fff;
    background-color: #FF7518;
    border-color: #FF7518;
}
.btn-warning {
    color: #fff;
    background-color: #FF7518;
    border-color: #FF7518;
}
.card-header{
    background-color: #9dacea;
    color:#333333;
    padding: 0.2rem 1.25rem;
  }
  
    
.h5{
    margin-bottom: 0rem;
}

.actived {
    background:#1abc9c !important;
    border-color:#16a085 !important;
}

.toRemove {
    background:#ff6b6b !important;
    border-color:#ee5253 !important;
}

.removedStatus {
    background: #c8d6e5 !important;
    border-color: #8395a7 !important;
}

tbody tr {
    cursor: pointer;
}



</style>
{{/extend}}

<div class="col-md-12">
        <ul class="nav nav-pills mb-3 nav-justified" id="pills-tab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true">Matriculados</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false">Retirados</a>
            </li>
        </ul>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                <div class="row">
                    <div class="col-md-2 col-xs-12">
                        <br>
                        <button class="btn btn-secondary btn-block" id="newEnrolled">
                            <i style="color:#3498db;" class="fa fa-plus"></i> Nueva matrícula
                        </button>
                        <button class="btn btn-secondary btn-block" id="pagosEnrolled" disabled>
                            <i style="color:#1abc9c;" class="far fa-money-bill-alt"></i> Pagos
                        </button>
                        <button class="btn btn-secondary btn-block" id="modStudentEnrolled" disabled>
                            <i style="color:#f1c40f;" class="fas fa-edit"></i> Modificar
                        </button>
                        <button class="btn btn-dark btn-block" id="optionStudentEnrolled" disabled>
                            <i style="color:#e67e22;" class="fas fa-filter"></i> Opciones
                        </button>
                        <button class="btn btn-dark btn-block" id="observationsEnrolled" disabled>
                            <i style="color:#9b59b6;" class="fas fa-eye"></i> Observaciones
                        </button>
                        <button class="btn btn-dark btn-block" id="closeMatrStudentEnrolled" disabled>
                            <i style="color:#e74c3c;" class="fas fa-ban"></i> Cerrar Matrícula
                        </button>
                    </div>
                
                    <div class="col-md-10 col-xs-12 box-shadows table-responsive">
                        <table id="tableEnrolledAlumns" class="display nowrap table table-condensed" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Rut</th>
                                    <th>Nombre</th>
                                    <th>Apellidos</th>
                                    <th></th>
                                    <th>Domicilio</th>
                                    <th>E-mail</th>
                                    <th>Celular</th>
                                    <th>Apoderado</th>
                                    <th>Parentesco</th>
                                </tr>
                            </thead>
                        </table>
                        <div id="loadingEnrolled">
                            <center>
                                <i style="color:#3498db;" class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
                                <span class="sr-only">Cargando...</span>
                            </center>
                        </div>
                    </div>
                </div>
        </div>
    
    
        <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
            <div class="container-fluid">
                <div class="tab-content">
                    <div class="tab-pane fade show active" style="margin-left:10px;margin-right:10px" id="#" role="tabpanel" aria-labelledby="enables-tab">
                        <div class="row">
                            <div class="col-md-2 col-xs-12">
                                
                                <button class="btn btn-secondary btn-block" id="pagosRetired" disabled>
                                    <i style="color:#1abc9c;" class="far fa-money-bill-alt"></i> Pagos
                                </button>
                                <button class="btn btn-secondary btn-block" id="modStudentRetired" disabled>
                                    <i style="color:#f1c40f;" class="fas fa-edit"></i> Modificar
                                </button>
                                <button class="btn btn-dark btn-block" id="optionStudentRetired" disabled>
                                    <i style="color:#e67e22;" class="fas fa-filter"></i> Opciones
                                </button>
                                <button class="btn btn-dark btn-block" id="observationsRetired" disabled>
                                    <i style="color:#9b59b6;" class="fas fa-eye"></i> Observaciones
                                </button>
                            </div>
                        
                            <div class="col-md-10 col-xs-12 box-shadows table-responsive">
                                <table id="tableDisabledAlumns" class="display nowrap table table-condensed" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Nº</th>
                                            <th>Rut</th>
                                            <th>Nombre</th>
                                            <th>Apellidos</th>
                                            <th></th>
                                            <th>Domicilio</th>
                                            <th>E-mail</th>
                                            <th>Celular</th>
                                            <th>Apoderado</th>
                                            <th>Parentesco</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div id="loadingDisabled">
                                    <center>
                                        <i style="color:#3498db;" class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
                                        <span class="sr-only">Cargando...</span>
                                    </center>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>

<!-- Modal formato-->
<div class="modal fade" id="modalEstudiantes" tabindex="-1" data-backdrop="static" role="dialog" aria-labelledby="modal_title" style="margin-top: 13px">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="background-color: #ffffff">
            <div class="modal-header" style="background:#333333; color:#fff">
                <h5 class="modal-title" id="modal_title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal_body"></div>
            <div class="modal-footer" id="modal_footer"></div>
        </div>
    </div>
</div>
{{#extend "js"}}
<script src="/public/logoCebalB64/logoCebal.js"></script>
<script src="/public/logoCebalB64/perfilAlumno.js"></script>
<script>
    
let defaultModalHTML = ''
let datatable
let datatableAlumnosEnrolled
let alumnosRowSelectedData
let alumnosRowSelected
let datatableAlumnosDisabled
let alumnosRowSelectedDataDisabled
let valores = {}
let allValues={ // calculos totales
    valorMatricula:0,
    cantidadCuotas:0,
    montoPorCuota:0,
    montoPorCuota2:0,
    totalCuotas:0,
    montoTotal:0,
    descuentoCuota1:0,
    descuentoCuota2:0
}

let numberQuotes = {}
let average = 'normal'
let typePayStatus = 0 //tipo de pago: 0 cuotas 1 contado
let selects = {
    graduated: [],
    notgraduated: [],
    selectedOptionEg: []
}
let statusBeca = 0 // becado o no becado
let chequeStatus = 0 // con o sin cheque
   
let place = '{{{credentials.place}}}';

    jQuery(document).ready(function ($) {
        chargeTableAlumnos();
        chargeTableAlumnosDisabled();
    });
       
    function chargeTableAlumnos() {
        datatableAlumnosEnrolled = $('#tableEnrolledAlumns')
        .DataTable({            
                    "iDisplayLength": 100,
                    "order": [[ 0, "desc" ]],
                    "oLanguage": {
                        "sSearch": "Buscar :"
                    },
                    "responsive": true,
                    "columns": [
                        { "data": "numMatricula" },
                        { "data": "_id"},
                        { "data": "name" },
                        { "data": "lastname1"},
                        { "data": "lastname2"},
                        { "data": "address"},
                        { "data": "email"},
                        { "data": "phone"},
                        { "data": "nameAp"},
                        { "data": "relationshipAp"}               
                    ],
                initComplete: function (settings, json) {
                    ajax({
                        url: 'api/studentsEnrolled'
                        
                    }).then(res => {
                        if (res.err) {
                            toastr.warning('No existen Alumnos matriculados')
                            $('#loadingEnrolled').empty();
                        } else if(res.ok) {
                            datatableAlumnosEnrolled.rows.add(res.ok).draw();
                            $('#loadingEnrolled').empty();
                        }      
                    })
                }
        });   
        
    $('#tableEnrolledAlumns tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            $('#pagosEnrolled').prop('disabled', true);
            $('#optionStudentEnrolled').prop('disabled', true);
            $('#modStudentEnrolled').prop('disabled', true);
            $('#closeMatrStudentEnrolled').prop('disabled', true);
            $('#observationsEnrolled').prop('disabled', true);
        } else {
            datatableAlumnosEnrolled.$('tr.selected').removeClass('selected');

            alumnosRowSelectedData = datatableAlumnosEnrolled.row($(this)).data();
            alumnosRowSelected = datatableAlumnosEnrolled.row($(this));
            console.log(alumnosRowSelectedData)
            if(typeof alumnosRowSelectedData !== 'undefined') {
                $(this).addClass('selected');
                $('#pagosEnrolled').prop('disabled', false);
                $('#optionStudentEnrolled').prop('disabled', false);
                $('#modStudentEnrolled').prop('disabled', false);
                $('#closeMatrStudentEnrolled').prop('disabled', false);
                $('#observationsEnrolled').prop('disabled', false);
            }
            
        }
    });
}

function disableAll() {
    $('#pagosEnrolled').prop('disabled', true);
    $('#optionStudentEnrolled').prop('disabled', true);
    $('#modStudentEnrolled').prop('disabled', true);
    $('#closeMatrStudentEnrolled').prop('disabled', true);
    $('#observationsEnrolled').prop('disabled', true);
}
//DATATABLE FINAL recargar
function reloadTableAlumnosEnrolled() {
        ajax({
            url: 'api/studentsEnrolled'
        }).then(res => {
        if (res.err) {
            toastr.warning('No existen Alumnos')
        } else {
            console.log(res)
            datatableAlumnosEnrolled.clear().draw();
            datatableAlumnosEnrolled.rows.add(res.ok).draw();
            $('#loadingEnrolled').empty();

        }
    })
}


//DATATABLE DISABLED ALUMNOS
function chargeTableAlumnosDisabled() {
    datatableAlumnosDisabled = $('#tableDisabledAlumns')
        .DataTable({            
            "iDisplayLength": 100,
            "oLanguage": {
                "sSearch": "Buscar :"
            },
            "responsive": true,
            "columns": [
                { "data": "numMatricula"},
                { "data": "_id"},
                { "data": "name" },
                { "data": "lastname1"},
                { "data": "lastname2"},
                { "data": "address"},
                { "data": "email"},
                { "data": "phone"},
                { "data": "nameAp"},
                { "data": "relationshipAp"}               
            ],
        initComplete: function (settings, json) {
            ajax({
                url: 'api/studentsDisabled'
            }).then(res => {
                if (res.err) {
                    // toastr.warning('No existen Alumnos retirados')
                    $('#loadingDisabled').empty();
                } else if(res.ok){
                    datatableAlumnosDisabled.rows.add(res.ok).draw();
                    $('#loadingDisabled').empty();
                }      
            })
        }
    });

    $('#tableDisabledAlumns tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            $('#pagosRetired').prop('disabled', true);
            $('#modStudentRetired').prop('disabled', true);
            $('#optionStudentRetired').prop('disabled', true);
            $('#observationsRetired').prop('disabled', true);
        } else {
            datatableAlumnosDisabled.$('tr.selected').removeClass('selected');

            alumnosRowSelectedDataDisabled = datatableAlumnosDisabled.row($(this)).data();
            alumnosRowSelectedDisabled = datatableAlumnosDisabled.row($(this));
            console.log(alumnosRowSelectedDataDisabled)
            
            if(typeof alumnosRowSelectedDataDisabled !== 'undefined') {
                
                $(this).addClass('selected');
                $('#pagosRetired').prop('disabled', false);
                $('#modStudentRetired').prop('disabled', false);
                $('#optionStudentRetired').prop('disabled',  false);
                $('#observationsRetired').prop('disabled', false);
            }
            
        }
    });
}
//DATATABLE FINAL recargar
function reloadTableAlumnosDisabled() {
        ajax({
            url: 'api/studentsDisabled'
        }).then(res => {
            if (res.err) {
                toastr.warning('No existen alumnos matriculados')
            } else {
                datatableAlumnosDisabled.clear().draw();
                datatableAlumnosDisabled.rows.add(res).draw();
            }
        })
}
//XXXXXXXXXX
//CERRAR MATRICULA
//MODIFICAR ESTUDIANTE MATRICULADO
$('#modStudentEnrolled').on('click', function(){
    modificarEstModal({student: alumnosRowSelectedData, rowSelected: alumnosRowSelected, datatableSelected: datatableAlumnosEnrolled})
})

$('#modStudentRetired').on('click', function(){
    modificarEstModal({student: alumnosRowSelectedDataDisabled, rowSelected: alumnosRowSelectedDisabled, datatableSelected: datatableAlumnosDisabled})
})

function modificarEstModal({student, rowSelected, datatableSelected}) {
    let studentData = student 
    let studentRowSelected = rowSelected 
    let studentDatatableSelected = datatableSelected

    $('#modalEstudiantes').modal()
    $('#modal_title').text(`Modificar estudiante`)

    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <h3 class="card-header">Datos de alumno</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Rut *</label>
                                    <input disabled value="${studentData._id}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese rut" id="newEnrolledRut">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Fecha de nacimiento *</label>
                                    <input value="${studentData.birthday}" class="form-control" type="text" placeholder="Fecha de nacimiento" id="newEnrolledBirthdate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Ciudad *</label>
                                    <input class="form-control" type="text" placeholder="Ciudad" value="{{{credentials.place}}}" disabled>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Nombre *</label>
                                    <input value="${studentData.name}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese nombre" id="newEnrolledName">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Apellido paterno *</label>
                                    <input value="${studentData.lastname1}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese apellido paterno" id="newEnrolledLastname">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Apellido materno</label>
                                    <input value="${studentData.lastname2}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese apellido materno" id="newEnrolledLastname2">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Email</label>
                                    <input value="${studentData.email}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="email" placeholder="Ingrese correo electrónico" id="newEnrolledEmail">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Teléfono</label>
                                    <input value="${studentData.phone}" class="form-control" type="text" placeholder="Ingrese número de telefono" id="newEnrolledPhone">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Dirección*</label>
                                    <input value="${studentData.address}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese Dirección" id="newEnrolledAddress">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-header">Datos de apoderado</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Nombre completo *</label>
                                    <input value="${studentData.nameAp}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Nombre completo del apoderado" id="newEnrolledAssigneeName">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Parentesco *</label>
                                    <input value="${studentData.relationshipAp}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="parentesco con alumno" id="newEnrolledAssigneeRelationship">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Lugar de trabajo</label>
                                    <input value="${studentData.workAp}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Lugar de trabajo del apoderado" id="newEnrolledAssigneeWorkplace">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Teléfono</label>
                                    <input value="${studentData.phoneAp}" class="form-control" type="text" placeholder="Teléfono del apoderado" id="newEnrolledAssigneePhone">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Email</label>
                                    <input value="${studentData.emailAp}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Correo electrónico del apoderado" id="newEnrolledAssigneeEmail">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-header">Datos académicos</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Colegio *</label>
                                    <input value="${studentData.matricula.colegio}" class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Nombre del colegio" id="newEnrolledSchool">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label generalTrigger">Egreso </label>
                                    
                                    <select class="custom-select" id="newEnrolledEgress" disabled>
                                        <option value="graduated">Egresado</option>
                                        <option value="notGraduated">No egresado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group" id="egressRes"></div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Becado </label>
                                    
                                    <select class="custom-select generalTrigger" id="newEnrolledBeca" disabled>
                                        <option value="no">No</option>
                                        <option value="yes">Si</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Promedio *</label>
                                    
                                    <input class="form-control generalTrigger solo-numero" type="text" placeholder="Ej: 6.0" id="newEnrolledAverage" disabled>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Horario </label>
                                    <select id="newEnrolledHorary"></select>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="col-form-label">ETP </label>
                                <select class="custom-select" id="newEnrolledEtpStatus">
                                    <option value="no">No</option>
                                    <option value="yes">Si</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group" id="electivesContainer">
                                    <label class="col-form-label">Electivos *</label>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="newEnrolledScience">
                                        <label class="custom-control-label" for="newEnrolledScience" >Ciencias</label>
                                    </div>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="newEnrolledHistory">
                                        <label class="custom-control-label" for="newEnrolledHistory" >Historia</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group" id="scienceRes"></div>
                            </div>


                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-header">Datos de matrícula</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Fecha de matrícula *</label>
                                    <input value="${studentData.matricula.fechaMatricula}" class="form-control" type="text" placeholder="Fecha de matrícula" id="newEnrolledDate" disabled>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Día de cobro </label>
                                    <select disabled class="custom-select" id="newEnrolledPayDay">
                                        <option value="01">01</option>
                                        <option value="02">02</option> 
                                        <option value="03">03</option> 
                                        <option value="04">04</option> 
                                        <option value="05">05</option> 
                                        <option value="06">06</option> 
                                        <option value="07">07</option> 
                                        <option value="08">08</option> 
                                        <option value="09">09</option> 
                                        <option value="10">10</option> 
                                        <option value="11">11</option> 
                                        <option value="12">12</option> 
                                        <option value="13">13</option> 
                                        <option value="14">14</option> 
                                        <option value="15">15</option> 
                                        <option value="16">16</option>
                                        <option value="17">17</option> 
                                        <option value="18">18</option> 
                                        <option value="19">19</option> 
                                        <option value="20">20</option> 
                                        <option value="21">21</option> 
                                        <option value="22">22</option> 
                                        <option value="23">23</option> 
                                        <option value="24">24</option> 
                                        <option value="25">25</option> 
                                        <option value="26">26</option> 
                                        <option value="27">27</option> 
                                        <option value="28">28</option> 
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Tipo de curso </label>
                                    <select disabled class="form-control generalTrigger" id="newEnrolledCourseType">
                                        <option value="yearly">Anual</option>
                                        <option value="intensive">Intensivo</option>
                                    </select> 
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Forma de pago </label>
                                    <select disabled class="form-control generalTrigger" id="newEnrolledPayType">
                                        <option value="cuotas">Cuotas</option>
                                        <option value="contado">Contado</option>
                                    </select> 
                                </div>
                            </div>
                            
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <center><h3><b>Descuentos</b></h3></center>
                            </div>
                        </div>

                        <div class="row">

                            
                            <div class="col-md-1"></div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Descuento 1 </label>
                                    <select class="form-control generalTrigger" id="newEnrolledDiscount" disabled>
                                        <option>Sin descuento (0%)</option>
                                        <option>Hijo de profesor (15%)</option>
                                        <option>Ex alumno (5%)</option>
                                        <option>Hermano (15%)</option>
                                    </select> 
                                </div>  
                            </div>

                            <div class="col-md-2"></div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Descuento 2 </label>
                                    <select class="form-control generalTrigger" id="newEnrolledDiscount2" disabled>
                                        <option>Sin descuento (0%)</option>
                                        <option>Hijo de profesor (15%)</option>
                                        <option>Ex alumno (5%)</option>
                                        <option>Hermano (15%)</option>
                                    </select> 
                                </div>  
                            </div>

                            <div class="col-md-1"></div>
                        </div>
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <h3 class="card-header">Pago de matrícula</h3>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="col-form-label">N° Boleta *</label>
                                                    <input class="form-control solo-numero" type="text" placeholder="Número de boleta" id="newEnrolledTicket" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <h3 class="card-header">Datos financieros</h3>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <table>
                                                    <tbody>
                                                        <tr>
                                                            <td>Valor matrícula </td>
                                                            <td><input class="form-control" type="text" placeholder="Valor matrícula" id="newEnrollmentInfoValue" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Cantidad cuotas </td>
                                                            <td><input class="form-control" type="text" placeholder="Cantidad cuotas" id="newEnrollmentInfoQtyQuotas" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Monto por cuota </td>
                                                            <td><input class="form-control" type="text" placeholder="Monto por cuota" id="newEnrollmentInfoAmountxQuota" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Total cuotas </td>
                                                            <td><input class="form-control" type="text" placeholder="Monto por cuota" id="newEnrollmentInfoQuotasTotal" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Monto total </td>
                                                            <td><input class="form-control" type="text" placeholder="Monto por cuota" id="newEnrollmentInfoTotalAmount" readOnly></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <div id="loadingGeneralData"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> 
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <br>
        <div id="errMessages"></div>
        <div class="col-md-12">
            <div class="row"> 
                <div class="offset-md-6 col-md-3" style="margin-top:15px;">
                    <button data-dismiss="modal" id="cancel" class="btn btn-secondary btn-block"><i style="color:#e74c3c;" class="fas fa-ban"></i> Cancelar</button>
                </div>
                <div class="col-md-3" style="margin-top:15px;">
                    <button id="saveNewEnrolled" class="btn btn-secondary btn-block"><i style="color:#3498db;" class="fas fa-cloud"></i> Guardar</button>
                </div>
            </div>
        </div>
    `)    
    egressStatus()
    becaStatus()
    prom()
    etpStatus()
    electiveStatus()
    payDay()
    tipoCurso()
    payType()
    discounts()
    ticket()
    values()

    $('#newEnrolledScience').on('change', function() {
        scienceStatus()
    })

    function values() {
        $('#newEnrollmentInfoValue').val(number_format(studentData.matricula.finance.valorMatricula))
        $('#newEnrollmentInfoQtyQuotas').val(studentData.matricula.finance.numCuotas)
        $('#newEnrollmentInfoAmountxQuota').val(number_format(studentData.matricula.finance.montoCuota))
        $('#newEnrollmentInfoQuotasTotal').val(number_format(studentData.matricula.finance.totalCuotas))
        $('#newEnrollmentInfoTotalAmount').val(number_format(studentData.matricula.finance.montoTotal))
    }

    function ticket() {
        $('#newEnrolledTicket').val(studentData.matricula.finance.ticketEnrollment)
    }

    function discounts() {
        $('#newEnrolledDiscount').val(studentData.matricula.finance.descuento)
        $('#newEnrolledDiscount2').val(studentData.matricula.finance.descuento2)
    }

    function payType() {
        if(studentData.matricula.finance.formaPago == 'Contado') {
            $('#newEnrolledPayType').val('contado')
        } else if(studentData.matricula.finance.formaPago == 'Cuotas') {
            $('#newEnrolledPayType').val('cuotas')
        }
    
    }

    function tipoCurso() {
        if(studentData.matricula.tipoCurso == 'Anual') {
            $('#newEnrolledCourseType').val('yearly')
        } else if(studentData.matricula.tipoCurso == 'Intensivo') {
            $('#newEnrolledCourseType').val('intensive')
        }
    }

    function payDay() {
        $('#newEnrolledPayDay').val(studentData.matricula.diaCobro) 
    }

    function egressStatus() {
        console.log(studentData.matricula.estadoEgreso)
        if(studentData.matricula.estadoEgreso == 'Egresado') {
            $('#newEnrolledEgress').val('graduated')
            $('#egressRes').html(`
                <label class="col-form-label">Año de egreso </label>                        
                <select class="custom-select" id="newEnrolledEgressRes">
                    <option value="2000">2000</option>
                    <option value="2001">2001</option>
                    <option value="2002">2002</option>
                    <option value="2003">2003</option>
                    <option value="2004">2004</option>
                    <option value="2005">2005</option>
                    <option value="2006">2006</option>
                    <option value="2007">2007</option>
                    <option value="2008">2008</option>
                    <option value="2009">2009</option>
                    <option value="2010">2010</option>
                    <option value="2011">2011</option>
                    <option value="2012">2012</option>
                    <option value="2013">2013</option>
                    <option value="2014">2014</option>
                    <option value="2015">2015</option>
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                    <option value="2018">2018</option>
                    <option value="2019">2019</option>
                    <option value="2020">2020</option>
                </select>
            `)
            
            
            $('#newEnrolledEgressRes').val(studentData.matricula.añoEgreso)    
            
        } else if(studentData.matricula.estadoEgreso == 'No egresado') {
            $('#newEnrolledEgress').val('notGraduated')

            $('#egressRes').html(`
                <label class="col-form-label">Cursando </label>                        
                <select class="custom-select" id="newEnrolledEgressRes">
                    <option value="primero medio">Primero medio</option>
                    <option value="segundo medio">Segundo medio</option>
                    <option value="tercero medio">Tercero medio</option>
                    <option value="cuarto medio">Cuarto medio</option>
                </select>
            `)

            
            $('#newEnrolledEgressRes').val(studentData.matricula.curso)    
             
        }
    }

    function electiveStatus() {
        if(studentData.matricula.electivo == 'Ciencias' || studentData.matricula.electivo2 == 'Ciencias'){
            $('#newEnrolledScience').prop('checked', true)

            $('#scienceRes').html(`
                <label class="col-form-label">electivo 2 *</label>                        
                <select class="custom-select" id="newEnrolledScienceRes">
                    <option value="physics">Física</option>
                    <option value="chemistry">Química</option>
                    <option value="biology">Biología</option>
                </select>
            `)

            if(studentData.matricula.electivoCiencias == 'Química') {
                $('#newEnrolledScienceRes').val('chemistry')
            } else if(studentData.matricula.electivoCiencias == 'Física') {
                $('#newEnrolledScienceRes').val('physics')
            } else if(studentData.matricula.electivoCiencias == 'Biología') {
                $('#newEnrolledScienceRes').val('biology')
            }
        }
        
        if(studentData.matricula.electivo == 'Historia' || studentData.matricula.electivo2 == 'Historia') {
            $('#newEnrolledHistory').prop('checked', true) 
        }
    }

    function scienceStatus() {
        let scienceStatus = $('#newEnrolledScience').prop('checked')
        console.log(scienceStatus)
        if(scienceStatus) {
            $('#scienceRes').html(`
                <label class="col-form-label">electivo 2 *</label>                        
                <select class="custom-select" id="newEnrolledScienceRes">
                    <option value="physics">Física</option>
                    <option value="chemistry">Química</option>
                    <option value="biology">Biología</option>
                </select>
            `)

            if(studentData.matricula.electivoCiencias == 'Química') {
                $('#newEnrolledScienceRes').val('chemistry')
            } else if(studentData.matricula.electivoCiencias == 'Física') {
                $('#newEnrolledScienceRes').val('physics')
            } else if(studentData.matricula.electivoCiencias == 'Biología') {
                $('#newEnrolledScienceRes').val('biology')
            }

        } else {
            $('#scienceRes').empty()
        }
    }

    function becaStatus() {
        if(studentData.matricula.beca == 'Si') {
            $('#newEnrolledBeca').val('yes')
        } else if(studentData.matricula.beca == 'No'){
            $('#newEnrolledBeca').val('no')
        }
    }

    function prom() {
        $('#newEnrolledAverage').val(studentData.matricula.promedio)
    }

    function etpStatus() {
        if(studentData.matricula.etp == 'Si') {
            $('#newEnrolledEtpStatus').val('yes')
        } else if(studentData.matricula.etp == 'No') {
            $('#newEnrolledEtpStatus').val('no')
        }
    }

    ajax({ // cargar horarios
        url:'/api/horariosCebalTraer'
    }).then(res => {
        let selects = {
            place:[],
            horary: []
        }
        console.log(res)
        selects.place = res.filter(function(el) {
            return el.place == '{{{credentials.place}}}'
        })
        console.log(selects.place)
        let horary = selects.place.reduce((arr, el, i) => {
            return arr.concat({
                id: i,
                text: el.horary
            })   
        }, []);

        console.log(horary)

        $('#newEnrolledHorary').select2({
            width:'100%',
            data: horary
        })
        

        let horarySelected = horary.filter(function(el){
            return el.text == studentData.matricula.horario
        })[0]

        $('#newEnrolledHorary').val(horarySelected.id).trigger('change');
    })

    $('#saveNewEnrolled').on('click', function(){
        $('#saveNewEnrolled').attr('disabled', true);

        let newEnrolledObj = {}
        let validateCounter = 0
        let errMessage = ''

        // ALUMNO
        newEnrolledObj.rut             = ktoK(cleanRut(studentData._id))
        newEnrolledObj.birthdate       = removeExtraSpaces($('#newEnrolledBirthdate').val()) //* 1
        newEnrolledObj.name            = removeExtraSpaces($('#newEnrolledName').val()) //* 2
        newEnrolledObj.lastname        = removeExtraSpaces($('#newEnrolledLastname').val()) //* 3
        newEnrolledObj.lastname2       = removeExtraSpaces($('#newEnrolledLastname2').val()) 
        newEnrolledObj.email           = removeExtraSpaces($('#newEnrolledEmail').val())
        newEnrolledObj.phone           = removeExtraSpaces($('#newEnrolledPhone').val())
        newEnrolledObj.address         = removeExtraSpaces($('#newEnrolledAddress').val()) //* 4

        // APODERADO
        newEnrolledObj.nameAp          = removeExtraSpaces($('#newEnrolledAssigneeName').val()) //* 5
        newEnrolledObj.relationshipAp  = removeExtraSpaces($('#newEnrolledAssigneeRelationship').val()) //* 6
        newEnrolledObj.workAp          = removeExtraSpaces($('#newEnrolledAssigneeWorkplace').val())
        newEnrolledObj.phoneAp         = removeExtraSpaces($('#newEnrolledAssigneePhone').val())
        newEnrolledObj.emailAp         = removeExtraSpaces($('#newEnrolledAssigneeEmail').val())
        
        // ACADEMICOS
        newEnrolledObj.school          = removeExtraSpaces($('#newEnrolledSchool').val()) //* 7
        newEnrolledObj.egressRes       = $('#newEnrolledEgressRes').val()
        newEnrolledObj.horary          = $('#newEnrolledHorary').select2('data')[0].text //* 8
        newEnrolledObj.etp             = $('#newEnrolledEtpStatus').val()
        newEnrolledObj.science         = $('#newEnrolledScience').is(':checked') //* 9
        newEnrolledObj.history         = $('#newEnrolledHistory').is(':checked') //* 9 
        newEnrolledObj.scienceElective = $('#newEnrolledScienceRes').val() || '' // si selecciona ciencias debe seleccionar 1
        
        
       

        if(newEnrolledObj.birthdate.length > 0) { // 1
            validateCounter++
            $('#newEnrolledBirthdate').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledBirthdate').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar una fecha de nacimiento válida.`
        }

        if(newEnrolledObj.name.length > 0) { // 2
            validateCounter++
            $('#newEnrolledName').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledName').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el nombre del alumno.`
        }

        if(newEnrolledObj.lastname.length > 0) { // 3
            validateCounter++
            $('#newEnrolledLastname').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledLastname').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el apellido paterno del alumno.`
        }

        if(newEnrolledObj.address.length > 0) { // 4
            validateCounter++
            $('#newEnrolledAddress').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledAddress').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar la dirección del alumno.`
        }

        if(newEnrolledObj.nameAp.length > 0) { // 5
            validateCounter++
            $('#newEnrolledAssigneeName').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledAssigneeName').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el nombre completo del apoderado.`
        }

        if(newEnrolledObj.relationshipAp.length > 0) { // 6
            validateCounter++
            $('#newEnrolledAssigneeRelationship').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledAssigneeRelationship').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el parentesco del apoderado con el alumno.`
        }

        if(newEnrolledObj.school.length > 0) { // 7
            validateCounter++
            $('#newEnrolledSchool').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledSchool').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el nombre del colegio del alumno.`
        }

        if(newEnrolledObj.horary.length > 0) { // 8
            validateCounter++
            $('#newEnrolledHorary').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledHorary').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe seleccionar un horario`
        }
        
        if(newEnrolledObj.science  || newEnrolledObj.history) { // 9
            validateCounter++
            $('#electivesContainer').css({border:'1px solid #3498db'})
        } else {
            $('#electivesContainer').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe seleccionar al menos 1 electivo`
        }

        if(newEnrolledObj.email.length > 0 && !isEmail(newEnrolledObj.email)) { // 9-1
            validateCounter = validateCounter-1
            $('#newEnrolledEmail').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar un correo de alumno válido.`
        } else if(newEnrolledObj.email.length > 0 && isEmail(newEnrolledObj.email)){
            $('#newEnrolledEmail').css({border:'1px solid #3498db'})
        } else if(newEnrolledObj.email.length == 0){
            $('#newEnrolledEmail').css({border:'1px solid #ced4da'})
        }
        
      
        if(newEnrolledObj.emailAp.length > 0 && !isEmail(newEnrolledObj.emailAp)) { // 9-1
            validateCounter = validateCounter-1
            $('#newEnrolledAssigneeEmail').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar un correo de apoderado válido.`
            console.log('correo apoderado incorrecto')
        } else if(newEnrolledObj.emailAp.length > 0 && isEmail(newEnrolledObj.emailAp)){
            $('#newEnrolledAssigneeEmail').css({border:'1px solid #3498db'})
            console.log('correo apoderado correcto')
        } else if(newEnrolledObj.emailAp.length == 0){
            $('#newEnrolledAssigneeEmail').css({border:'1px solid #ced4da'})
            console.log('sin correo apoderado')
        }
        
        if(validateCounter == 9) {
            $('#errMessages').empty()
            
            updateEnrollment(newEnrolledObj)
            
        } else {
            $('#saveNewEnrolled').attr('disabled', false);

            $('#errMessages').html(`
            <div class="alert alert-dismissible alert-warning">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4 class="alert-heading">Debe solucionar los siguientes errores:</h4>
                <p class="mb-0">${errMessage}</p>
            </div>
            `)
        }

    })
    
    function updateEnrollment(data) {
        swal({
            title: '¿Seguro de modificar al estudiante?',
            type: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Si, modificar.',
            cancelButtonText: 'No, cancelar.'
        }).then((result) => {
            if (result.value) {
                let sendData = {
                    //ALUMNO
                    studentRut          :data.rut,
                    studentBirthdate    :data.birthdate,
                    studentName         :data.name,
                    studentLastname     :data.lastname,   
                    studentLastname2    :data.lastname2,
                    studentEmail        :data.email,
                    studentPhone        :data.phone,
                    studentAddress      :data.address,
                    //APODERADO
                    assigneeName        :data.nameAp,
                    assigneeRelationship:data.relationshipAp,
                    assigneeWork        :data.workAp,
                    assigneePhone       :data.phoneAp,
                    assigneeEmail       :data.emailAp,
                    //ACADEMICOS
                    school              :data.school,
                    egressRes           :data.egressRes,
                    horary              :data.horary,
                    etp                 :data.etp,
                    science             :data.science,
                    history             :data.history,
                    scienceElective     :data.scienceElective,
                }

                console.log(sendData)
                
                ajax({
                    url: '/api/modEnrollment',
                    type: 'POST',
                    data: sendData 
                }).then(res => {
                    console.log(res)
                    if(res.ok) {

                        $('#pagosRetired').prop('disabled', true);
                        $('#modStudentRetired').prop('disabled', true);
                        $('#optionStudentRetired').prop('disabled', true);
                        $('#observationsRetired').prop('disabled', true);
                        toastr.success('Alumno modificado correctamente')
                        $('#modalEstudiantes').modal('hide')
                        res.ok._id = rutFunc(res.ok._id)
                        res.ok.numMatricula = res.ok.matricula.numMatricula

                        studentRowSelected.remove().draw();
                        let newStudentRowAdded = studentDatatableSelected.row.add(res.ok)
                        .draw()
                        .node()

                        $(newStudentRowAdded).css('color', '#1abc9c')
                        setTimeout(() => {
                            $(newStudentRowAdded).css('color', '#484848')
                        }, 5000);
                    } else if(res.err) {
                        $('#saveNewEnrolled').attr('disabled', false);
                        toastr.warning(res.err)
                    }
                })      
            } else if(result.dismiss) {
                $('#saveNewEnrolled').attr('disabled', false);
            }
        })
    }
};

$('#newEnrolled').on('click', function() {
    $('#modalEstudiantes').modal()
    $('#modal_title').text(`Crear una nueva matrícula`)

    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <h3 class="card-header">Datos de alumno</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Rut *</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese rut" id="newEnrolledRut">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Fecha de nacimiento *</label>
                                    <input class="form-control" type="text" placeholder="Fecha de nacimiento" id="newEnrolledBirthdate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Ciudad *</label>
                                    <input class="form-control" type="text" placeholder="Ciudad" value="{{{credentials.place}}}" disabled>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Nombre *</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese nombre" id="newEnrolledName">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Apellido paterno *</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese apellido paterno" id="newEnrolledLastname">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Apellido materno</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese apellido materno" id="newEnrolledLastname2">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Email</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="email" placeholder="Ingrese correo electrónico" id="newEnrolledEmail">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Teléfono</label>
                                    <input class="form-control" type="text" placeholder="Ingrese número de telefono" id="newEnrolledPhone">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Dirección*</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Ingrese Dirección" id="newEnrolledAddress">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-header">Datos de apoderado</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Nombre completo *</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Nombre completo del apoderado" id="newEnrolledAssigneeName">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Parentesco *</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="parentesco con alumno" id="newEnrolledAssigneeRelationship">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Lugar de trabajo</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Lugar de trabajo del apoderado" id="newEnrolledAssigneeWorkplace">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Teléfono</label>
                                    <input class="form-control" type="text" placeholder="Teléfono del apoderado" id="newEnrolledAssigneePhone">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Email</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Correo electrónico del apoderado" id="newEnrolledAssigneeEmail">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-header">Datos académicos</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Colegio *</label>
                                    <input class="form-control" onkeyup="minToCapital(event, this)" onblur="minToCapital(event, this)" type="text" placeholder="Nombre del colegio" id="newEnrolledSchool">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label generalTrigger">Egreso </label>
                                    
                                    <select class="custom-select" id="newEnrolledEgress">
                                        <option value="graduated">Egresado</option>
                                        <option value="notGraduated">No egresado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group" id="egressRes"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Becado </label>
                                    
                                    <select class="custom-select generalTrigger" id="newEnrolledBeca">
                                        <option value="no">No</option>
                                        <option value="yes">Si</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Promedio *</label>
                                    
                                    <input class="form-control generalTrigger solo-numero" type="text" placeholder="Ej: 6.0" id="newEnrolledAverage">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Horario </label>
                                    <select id="newEnrolledHorary"></select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="col-form-label">ETP </label>
                                <select class="custom-select" id="newEnrolledEtpStatus">
                                    <option value="no">No</option>
                                    <option value="yes">Si</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group" id="electivesContainer">
                                    <label class="col-form-label">Electivos *</label>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="newEnrolledScience">
                                        <label class="custom-control-label" for="newEnrolledScience" >Ciencias</label>
                                    </div>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="newEnrolledHistory">
                                        <label class="custom-control-label" for="newEnrolledHistory" >Historia</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group" id="scienceRes"></div>
                            </div>


                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-header">Datos de matrícula</h3>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Fecha de matrícula *</label>
                                    <input class="form-control" type="text" placeholder="Fecha de matrícula" id="newEnrolledDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-form-label">Día de cobro </label>
                                    <select class="custom-select" id="newEnrolledPayDay">
                                        <option value="01">01</option>
                                        <option value="02">02</option> 
                                        <option value="03">03</option> 
                                        <option value="04">04</option> 
                                        <option value="05">05</option> 
                                        <option value="06">06</option> 
                                        <option value="07">07</option> 
                                        <option value="08">08</option> 
                                        <option value="09">09</option> 
                                        <option value="10">10</option> 
                                        <option value="11">11</option> 
                                        <option value="12">12</option> 
                                        <option value="13">13</option> 
                                        <option value="14">14</option> 
                                        <option value="15">15</option> 
                                        <option value="16">16</option>
                                        <option value="17">17</option> 
                                        <option value="18">18</option> 
                                        <option value="19">19</option> 
                                        <option value="20">20</option> 
                                        <option value="21">21</option> 
                                        <option value="22">22</option> 
                                        <option value="23">23</option> 
                                        <option value="24">24</option> 
                                        <option value="25">25</option> 
                                        <option value="26">26</option> 
                                        <option value="27">27</option> 
                                        <option value="28">28</option> 
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Tipo de curso </label>
                                    <select class="form-control generalTrigger" id="newEnrolledCourseType">
                                        <option value="yearly">Anual</option>
                                        <option value="intensive">Intensivo</option>
                                    </select> 
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Forma de pago </label>
                                    <select class="form-control generalTrigger" id="newEnrolledPayType">
                                        <option value="cuotas">Cuotas</option>
                                        <option value="contado">Contado</option>
                                    </select> 
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Año de cobro de cuotas </label>
                                    <select class="form-control" id="newEnrolledYearSelected">
                                        <option value="current">Actual</option>
                                        <option value="next">Siguiente</option>
                                    </select> 
                                </div>  
                            </div>
                            
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <center><h3><b>Descuentos</b></h3></center>
                            </div>
                        </div>

                        <div class="row">

                            
                            <div class="col-md-1"></div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Descuento 1 </label>
                                    <select class="form-control generalTrigger" id="newEnrolledDiscount">
                                        <option>Sin descuento (0%)</option>
                                        <option>Hijo de profesor (15%)</option>
                                        <option>Ex alumno (5%)</option>
                                        <option>Hermano (15%)</option>
                                    </select> 
                                </div>  
                            </div>

                            <div class="col-md-2"></div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Descuento 2 </label>
                                    <select class="form-control generalTrigger" id="newEnrolledDiscount2" disabled>
                                        <option>Sin descuento (0%)</option>
                                        <option>Hijo de profesor (15%)</option>
                                        <option>Ex alumno (5%)</option>
                                        <option>Hermano (15%)</option>
                                    </select> 
                                </div>  
                            </div>

                            <div class="col-md-1"></div>
                        </div>
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <h3 class="card-header">Pago de matrícula</h3>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="col-form-label">¿Desea pagar la primera cuota? </label>
                                                    <select class="custom-select" id="newEnrolledFirstQuotaPay">
                                                        <option value="no">No</option>
                                                        <option value="yes">Si</option> 
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="col-form-label">Medio de pago </label>
                                                    <select class="custom-select" id="newEnrolledPaymentMethod">
                                                        <option value="cash">Efectivo</option>
                                                        <option value="check">Cheque</option>
                                                        <option value="transfer">Transferencia</option> 
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-12">
                                                <div id="paymentRes"></div>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="col-form-label">N° Boleta *</label>
                                                    <input class="form-control solo-numero" type="text" placeholder="Número de boleta" id="newEnrolledTicket">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <h3 class="card-header">Datos financieros</h3>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <table>
                                                    <tbody>
                                                        <tr>
                                                            <td>Valor matrícula </td>
                                                            <td><input class="form-control" type="text" placeholder="Valor matrícula" id="newEnrollmentInfoValue" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Cantidad cuotas </td>
                                                            <td><input class="form-control" type="text" placeholder="Cantidad cuotas" id="newEnrollmentInfoQtyQuotas" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Monto por cuota </td>
                                                            <td><input class="form-control" type="text" placeholder="Monto por cuota" id="newEnrollmentInfoAmountxQuota" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Total cuotas </td>
                                                            <td><input class="form-control" type="text" placeholder="Monto por cuota" id="newEnrollmentInfoQuotasTotal" readOnly></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Monto total </td>
                                                            <td><input class="form-control" type="text" placeholder="Monto por cuota" id="newEnrollmentInfoTotalAmount" readOnly></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <div id="loadingGeneralData"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> 
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <br>
        <div id="errMessages"></div>
        
        <div class="col-md-12">
            <div class="row"> 
                <div class="offset-md-6 col-md-3" style="margin-top:15px;">
                    <button data-dismiss="modal" id="cancel" class="btn btn-secondary btn-block"><i style="color:#e74c3c;" class="fas fa-ban"></i> Cancelar</button>
                </div>
                <div class="col-md-3" style="margin-top:15px;">
                    <button id="saveNewEnrolled" class="btn btn-secondary btn-block"><i style="color:#3498db;" class="fas fa-cloud"></i> Guardar</button>
                </div>
            </div>
        </div>
        
    `)
    egressStatus()
    generalFunction()

    $('.solo-numero').keyup(function (){
        this.value = (this.value + '').replace(/[^0-9]/g, ''); 
    })

    $('input#newEnrolledRut').keyup(function (){
        if(isRut($(this).val())) {
            $(this).val(rutFunc($(this).val()))
            $(this).css({border:'1px solid #3498db'})
        } else {
            $(this).css({border:'1px solid #e74c3c'})
        }
    })

    $('#newEnrolledDate').daterangepicker({
        "locale": {
            "format": "DD/MM/YYYY",
            "daysOfWeek": [
            "Dom",
            "Lun",
            "Mar",
            "Mie",
            "Jue",
            "Vie",
            "Sab"
            ],
            "monthNames": [
            "Enero",
            "Febrero",
            "Marzo",
            "Abril",
            "Mayo",
            "Junio",
            "Julio",
            "Agosto",
            "Septiembre",
            "Octubre",
            "Noviembre",
            "Diciembre"
            ],
            "firstDay": 1
        },
        drops: "down",
        singleDatePicker: true,
        showDropdowns: true
    })

    $('#newEnrolledBirthdate').daterangepicker({
        "locale": {
            "format": "DD/MM/YYYY",
            "daysOfWeek": [
            "Dom",
            "Lun",
            "Mar",
            "Mie",
            "Jue",
            "Vie",
            "Sab"
            ],
            "monthNames": [
            "Enero",
            "Febrero",
            "Marzo",
            "Abril",
            "Mayo",
            "Junio",
            "Julio",
            "Agosto",
            "Septiembre",
            "Octubre",
            "Noviembre",
            "Diciembre"
            ],
            "firstDay": 1
        },
        drops: "down",
        singleDatePicker: true,
        showDropdowns: true
    })

    $('#newEnrolledPaymentMethod').on('change', function() {
        if($(this).val() == 'check') {
            chequeStatus = 1;
            $('#paymentRes').html(`
                <div class="col-md-12" style="margin-top:10px;">
                    <div class="row">
                        <div class="col-md-6">
                            <label style="float:left;"> Banco *</label>
                            <input id="chequeBanco" type="text" value="" placeholder="Nombre del banco" class="form-control border-input">
                        </div>
                        <div class="col-md-6">
                            <label style="float:left;"> Nº Serie *</label>
                            <input id="chequeNum" type="text" value="" placeholder="Número de serie del cheque" class="form-control border-input">
                        </div>
                        <div class="col-md-6">
                            <label style="float:left;"> Monto cheque *</label>
                            <input id="chequeMonto" type="text" value="" placeholder="Monto del cheque" class="form-control border-input">
                        </div> 
                        <div class="col-md-6">
                            <label style="float:left;"> Fecha pago *</label>
                            <input id="chequeFecha" type="text" value="" placeholder="Fecha de pago del cheque" class="form-control border-input">
                        </div>
                        
                    </div>
                </div>
                <br>
            `)
            $('#chequeFecha').daterangepicker({
                "locale": {
                    "format": "DD/MM/YYYY",
                    "daysOfWeek": [
                    "Dom",
                    "Lun",
                    "Mar",
                    "Mie",
                    "Jue",
                    "Vie",
                    "Sab"
                    ],
                    "monthNames": [
                    "Enero",
                    "Febrero",
                    "Marzo",
                    "Abril",
                    "Mayo",
                    "Junio",
                    "Julio",
                    "Agosto",
                    "Septiembre",
                    "Octubre",
                    "Noviembre",
                    "Diciembre"
                    ],
                    "firstDay": 1
                },
                drops: "up",
                singleDatePicker: true,
                showDropdowns: true
            });
        } else {
            $('#paymentRes').empty()
            chequeStatus = 0;
        }
    })

    

    $('.generalTrigger').on('change', function() {
        generalFunction()
    })

    $('#newEnrolledAverage').on('keyup', function (e){ // al escribir en input "promedio"
        generalFunction()
    })

    $('#newEnrolledAverage').on('change', function (e){ // al cambiar el valor del input "promedio"
        validarValorPromedio()
    })

    $('#newEnrolledEgress').on('change', function() {
        egressStatus()
    })

    $('#newEnrolledScience').on('change', function() {
        scienceStatus()
    })

    function generalFunction() {
        //$('#saveNewEnrolled').attr('disabled', true)

        $('#loadingGeneralData').html(`
            <center>
                <i style="color:#3498db;" class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
                <span class="sr-only">Cargando...</span>
            </center>`
        )

        quotaValues().then(res=> {
            numberQuotesCebal().then(res => {
                traerNotas().then(res=> {
                    wayToPay().then(res=> {
                        calcularDescuento1().then(res=> {
                            calcularDescuento2().then(res=> {
                                beca().then(res=> {
                                    calcularMontoTotal().then(res=> {
                                        $('#loadingGeneralData').empty()
                                        let ticket = $('#newEnrolledTicket').val()
                                        if(ticket !== ''){
                                            $('#saveNewEnrolled').attr('disabled', false);
                                        }
                                        console.log('FINAL', valores, allValues, numberQuotes, typePayStatus)
                                    })
                                })
                            })
                        })
                    })
                })
            })
        })
    }

    //Promedio min 10 y max 70
    function validarValorPromedio(){
        let maxMin = $('#newEnrolledAverage').val()
        if(maxMin > 70){
            $('#newEnrolledAverage').val('')
            toastr.warning("Ingrese un promedio válido (10 a 70)")
        }else if (maxMin < 10){
            $('#newEnrolledAverage').val('')
            toastr.warning("Ingrese un promedio válido (10 a 70)")
        }
    }
    /*
        GENERAL FUNCTIONS INIT
    */

    function quotaValues (){ 
        return new Promise(resolve =>{
            ajax({ 
                url:'/api/quotaValuesCebal'
            }).then(res => {
                let selectedStatus = $('#newEnrolledEgress').val();
                if (selectedStatus == 'graduated'){

                    valores.graduated = res.filter(function(el) {
                        return el.status == 'graduated';
                    })[0].notes

                    let matrScore = valores.graduated.filter(function(el) {
                        return el.score == 'matricula';
                    })[0].price
                    
                    let valNormal = valores.graduated.filter(function(el) {
                        return el.score == 'normal';
                    })[0].price


                    allValues.valorMatricula = matrScore;
                    allValues.montoPorCuota = valNormal;
                
                    setTimeout(() => {
                        resolve()
                    }, 100);
                    
                }else{
                    valores.notgraduated = res.filter(function(el) {
                        return el.status == 'notGraduated';
                    })[0].notes
                    let matrScore = valores.notgraduated.filter(function(el) {
                        return el.score == 'matricula';
                    })[0].price

                    let valNormal = valores.notgraduated.filter(function(el) {
                        return el.score == 'normal';
                    })[0].price

                    allValues.valorMatricula = matrScore;
                    allValues.montoPorCuota= valNormal;
                
                    setTimeout(() => {
                        resolve()
                    }, 100);
                }
            });
        })
    
    }

    function numberQuotesCebal (){
        return new Promise(resolve =>{
            ajax({ 
                url:'/api/quotaNumbers'
            }).then(res => {
                let selectedTypeCourse = $('#newEnrolledCourseType').val();
                if (selectedTypeCourse === 'yearly'){

                    numberQuotes.yearly = res.filter(function(el) {
                        return el.type == 'yearly';
                    })[0].quotaNumber

                    allValues.cantidadCuotas= numberQuotes.yearly;

                    setTimeout(() => {
                        console.log("cuotas anual",allValues.cantidadCuotas)
                        resolve()
                    }, 100);
                    
                }else if(selectedTypeCourse==='intensive'){

                    numberQuotes.intensive = res.filter(function(el) {
                        return el.type == 'intensive';
                    })[0].quotaNumber
                    allValues.cantidadCuotas= numberQuotes.intensive;
                    
                    setTimeout(() => {
                        console.log("cuotas intensivo",allValues.cantidadCuotas)
                        resolve()
                    }, 100);
                }
            });
        });
    }

    function traerNotas(){
        return new Promise(resolve =>{
            ajax({ 
                url:'/api/quotaValuesCebal'
            }).then(res => {
                let estado = $('#newEnrolledEgress').val()
                console.log("estado seleccionado",estado)
                console.log("promedio inicio",average)
        
                average = $('#newEnrolledAverage').val()

                if (estado == 'graduated'){
                    selects.graduated = res.filter(function(el) {
                        return el.status == 'graduated';
                    })[0].notes

                    let promedioSelected = selects.graduated.filter(function(el){
                        return el.score  == average
                    })
                    if (promedioSelected[0]){
                        promedioSelected = promedioSelected[0].price
                        allValues.montoPorCuota = promedioSelected;

                        setTimeout(() => {
                            resolve()
                        }, 100);
                        
                    }else{
                        average = 'normal'
                        let normal = selects.graduated.filter(function(el) {
                        return el.score == 'normal';
                        })[0].price
                        allValues.montoPorCuota = normal;

                        setTimeout(() => {
                            resolve()
                        }, 100);
                    } 
                    /*
                    setTimeout(() => {
                        resolve()
                    }, 100);
                    */

                }else if(estado == 'notGraduated'){
                    selects.notgraduated = res.filter(function(el) {
                        return el.status == 'notGraduated';
                    })[0].notes
                    let promedioSelected2 = selects.notgraduated.filter(function(el){
                        return el.score  == average
                    })
                    if (promedioSelected2[0]){
                        promedioSelected2 = promedioSelected2[0].price
                        allValues.montoPorCuota = promedioSelected2;
                        setTimeout(() => {
                            resolve()
                        }, 100);
                    }else{
                        average = 'normal'
                        let normal2 = selects.notgraduated.filter(function(el) {
                        return el.score == 'normal';
                        })[0].price
                        allValues.montoPorCuota = normal2;
                        setTimeout(() => {
                            resolve()
                        }, 100);
                    } 
                    /*
                    setTimeout(() => {
                        resolve()
                    }, 100);
                    */
                }
            })
        })
    }

    function wayToPay(){
        return new Promise(resolve =>{
            let selectedTypePay = $('#newEnrolledPayType').val();
            console.log('TYPEPAY', selectedTypePay)
            if(selectedTypePay == 'cuotas'){
                typePayStatus = 1;
                let tipoAnualIntensivo = $('#newEnrolledCourseType').val();
                //resolve()
                if (tipoAnualIntensivo == 'yearly'){
                    typePayStatus = 0
                    allValues.cantidadCuotas = 9
                    allValues.totalCuotas = (allValues.montoPorCuota * allValues.cantidadCuotas)
                
                    resolve()
                }else if (tipoAnualIntensivo == 'intensive'){
                    typePayStatus = 0
                    allValues.cantidadCuotas = 5
                    allValues.totalCuotas = (allValues.montoPorCuota * allValues.cantidadCuotas)
                
                    resolve()
                }
            }else if (selectedTypePay == 'contado'){ // si es al contado: intensivo tiene un 10% de descuento | anual tiene un 20% de descuento
                typePayStatus = 1;
                let tipoAnualIntensivo = $('#newEnrolledCourseType').val();
                //resolve()
                if (tipoAnualIntensivo == 'yearly'){
                    allValues.totalCuotas  = (allValues.montoPorCuota * allValues.cantidadCuotas)-(allValues.montoPorCuota * allValues.cantidadCuotas)*0.20;
                    allValues.montoPorCuota = allValues.totalCuotas;
                    allValues.cantidadCuotas = 1
                
                    resolve()
                }else if (tipoAnualIntensivo == 'intensive'){
                    allValues.totalCuotas  = (allValues.montoPorCuota * allValues.cantidadCuotas)-(allValues.montoPorCuota * allValues.cantidadCuotas)*0.10;
                    allValues.montoPorCuota = allValues.totalCuotas;
                    allValues.cantidadCuotas = 1
                
                    resolve()
                }
            }
        })
    }

    //calcular los descuentos
    function calcularDescuento1(){
        return new Promise(resolve =>{
            let descuento = $('#newEnrolledDiscount').val()
            if(descuento === 'Hijo de profesor (15%)'){
                allValues.descuentoCuota1 = allValues.montoPorCuota * 0.15;
                let montoxCuota = allValues.montoPorCuota - allValues.descuentoCuota1
                allValues.montoPorCuota = Math.floor(montoxCuota)
                let totalAllCuotas = allValues.cantidadCuotas * allValues.montoPorCuota
                allValues.totalCuotas= Math.floor(totalAllCuotas)
                $('#newEnrolledDiscount2 option:eq(2)').prop('disabled', false)
                $('#newEnrolledDiscount2 option:eq(3)').prop('disabled', false)
                $('#newEnrolledDiscount2 option:eq(1)').prop('disabled', true)
                $('#newEnrolledDiscount2').prop('disabled', false)
                resolve()
            }else if(descuento ==='Hermano (15%)'){
                allValues.descuentoCuota1= allValues.montoPorCuota * 0.15
                let montoxCuota = allValues.montoPorCuota-allValues.descuentoCuota1
                allValues.montoPorCuota = Math.floor(montoxCuota)
                let totalAllCuotas=allValues.cantidadCuotas*allValues.montoPorCuota
                allValues.totalCuotas= Math.floor(totalAllCuotas)
                $('#newEnrolledDiscount2 option:eq(1)').prop('disabled', false)
                $('#newEnrolledDiscount2 option:eq(2)').prop('disabled', false)
                $('#newEnrolledDiscount2 option:eq(3)').prop('disabled', true)
                $('#newEnrolledDiscount2').prop('disabled', false)
                resolve()
            }else if(descuento ==='Ex alumno (5%)'){
                allValues.descuentoCuota1= allValues.montoPorCuota * 0.05;
                let montoxCuota = allValues.montoPorCuota-allValues.descuentoCuota1
                allValues.montoPorCuota = Math.floor(montoxCuota)
                let totalAllCuotas=allValues.cantidadCuotas*allValues.montoPorCuota
                allValues.totalCuotas= Math.floor(totalAllCuotas)
                $('#newEnrolledDiscount2 option:eq(1)').prop('disabled', false)
                $('#newEnrolledDiscount2 option:eq(3)').prop('disabled', false)
                $('#newEnrolledDiscount2 option:eq(2)').prop('disabled', true)
                $('#newEnrolledDiscount2').prop('disabled', false)
                resolve()
            }else if (descuento ==='Sin descuento (0%)'){
                $('#newEnrolledDiscount2').prop('disabled', true)
                $('#newEnrolledDiscount2').val('Sin descuento (0%)')
                resolve()
            }else{
                resolve()
            }
        })
    }


    function calcularDescuento2(){
        return new Promise(resolve =>{
            let descuento2 = $('#newEnrolledDiscount2').val()
            if(descuento2 === 'Hijo de profesor (15%)' || descuento2 === 'Hermano (15%)'){
                
                let montoxCuotas =(allValues.montoPorCuota)-(allValues.montoPorCuota)*0.15
                allValues.montoPorCuota = Math.floor(montoxCuotas)
                let totalAllCuota = allValues.montoPorCuota*allValues.cantidadCuotas
                allValues.totalCuotas = Math.floor(totalAllCuota)

                resolve()
            }else if(descuento2 === 'Ex alumno (5%)'){
                let montoxCuotas = (allValues.montoPorCuota)-(allValues.montoPorCuota)*0.05
                allValues.montoPorCuota = Math.floor(montoxCuotas)
                let totalAllCuota=allValues.montoPorCuota*allValues.cantidadCuotas
                allValues.totalCuotas= Math.floor(totalAllCuota)
                resolve()
            
            }else{
                resolve()
            }
        })
    }

    //becado o no becado
    function beca(){
        return new Promise(resolve =>{
            let beca = $('#newEnrolledBeca').val()
            if (beca === 'yes'){
                statusBeca = 1
                allValues.cantidadCuotas = 0
                allValues.montoPorCuota = 0
                allValues.totalCuotas = 0
                $('#newEnrolledPayType').val('contado')
                $('#newEnrolledPayType').prop('disabled', true)
                $('#newEnrolledPayDay').val('01')
                $('#newEnrolledPayDay').prop('disabled', true)
                resolve()
            }else if (beca === 'no'){
                statusBeca = 0
                $('#newEnrolledPayType').prop('disabled', false)
                //$('#newEnrolledPayDay').val('01') // Puede ser cualquier día
                $('#newEnrolledPayDay').prop('disabled', false)
                resolve()
            }
        })
    }

    //calcular el monto de la matricula de un alumno
    function calcularMontoTotal(){
        return new Promise(resolve=> {
            $('#newEnrollmentInfoValue').val(number_format(allValues.valorMatricula))
            $('#newEnrollmentInfoQtyQuotas').val(allValues.cantidadCuotas)
            $('#newEnrollmentInfoAmountxQuota').val(number_format(Math.floor(allValues.montoPorCuota)))
            $('#newEnrollmentInfoQuotasTotal').val(number_format(Math.floor(allValues.totalCuotas)))
            let montoTotalFinish =  (allValues.totalCuotas+allValues.valorMatricula)
            $('#newEnrollmentInfoTotalAmount').val(number_format(Math.floor(montoTotalFinish)))
            resolve()
        })
    }

    /*
        GENERAL FUNCTIONS END
    */

    function scienceStatus() {
        let scienceStatus = $('#newEnrolledScience').prop('checked')
        console.log(scienceStatus)
        if(scienceStatus) {
            $('#scienceRes').html(`
                <label class="col-form-label">electivo 2 *</label>                        
                <select class="custom-select" id="newEnrolledScienceRes">
                    <option value="physics">Física</option>
                    <option value="chemistry">Química</option>
                    <option value="biology">Biología</option>
                </select>
            `)

        } else {
            $('#scienceRes').empty()
        }
    }

    function egressStatus() {
        let egressStatus = $('#newEnrolledEgress').val()
        
        if(egressStatus == 'graduated') {
            $('#egressRes').html(`
                <label class="col-form-label">Año de egreso </label>                        
                <select class="custom-select" id="newEnrolledEgressRes">
                    <option value="2000">2000</option>
                    <option value="2001">2001</option>
                    <option value="2002">2002</option>
                    <option value="2003">2003</option>
                    <option value="2004">2004</option>
                    <option value="2005">2005</option>
                    <option value="2006">2006</option>
                    <option value="2007">2007</option>
                    <option value="2008">2008</option>
                    <option value="2009">2009</option>
                    <option value="2010">2010</option>
                    <option value="2011">2011</option>
                    <option value="2012">2012</option>
                    <option value="2013">2013</option>
                    <option value="2014">2014</option>
                    <option value="2015">2015</option>
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                    <option value="2018">2018</option>
                    <option value="2019">2019</option>
                    <option value="2020">2020</option>
                </select>
            `)
        } else if(egressStatus == 'notGraduated') {
            $('#egressRes').html(`
                <label class="col-form-label">Cursando </label>                        
                <select class="custom-select" id="newEnrolledEgressRes">
                    <option value="primero medio">Primero medio</option>
                    <option value="segundo medio">Segundo medio</option>
                    <option value="tercero medio">Tercero medio</option>
                    <option value="cuarto medio">Cuarto medio</option>
                </select>
            `)
        }
    }

    ajax({ // cargar horarios
        url:'/api/horariosCebalTraer'
    }).then(res => {
        let selects = {
            place:[],
            horary: []
        }
        console.log(res)
        selects.place = res.filter(function(el) {
            return el.place == '{{{credentials.place}}}'
        })
        console.log(selects.place)
        let horary = selects.place.reduce((arr, el, i) => {
            return arr.concat({
                id: i,
                text: el.horary
            })   
        }, []);

        console.log(horary)

        $('#newEnrolledHorary').select2({
            width:'100%',
            data: horary
        })
    })

    $('#saveNewEnrolled').on('click', function(){
        $('#saveNewEnrolled').attr('disabled', true);

        let newEnrolledObj = {}
        let validateCounter = 0
        let errMessage = ''

        // ALUMNO
        newEnrolledObj.rut             = removeExtraSpaces($('#newEnrolledRut').val()) //* 1
        newEnrolledObj.birthdate       = removeExtraSpaces($('#newEnrolledBirthdate').val()) //* 2
        newEnrolledObj.name            = removeExtraSpaces($('#newEnrolledName').val()) //* 3
        newEnrolledObj.lastname        = removeExtraSpaces($('#newEnrolledLastname').val()) //* 4
        newEnrolledObj.lastname2       = removeExtraSpaces($('#newEnrolledLastname2').val()) 
        newEnrolledObj.email           = removeExtraSpaces($('#newEnrolledEmail').val())
        newEnrolledObj.phone           = removeExtraSpaces($('#newEnrolledPhone').val())
        newEnrolledObj.address         = removeExtraSpaces($('#newEnrolledAddress').val()) //* 5

        // APODERADO
        newEnrolledObj.nameAp          = removeExtraSpaces($('#newEnrolledAssigneeName').val()) //* 6
        newEnrolledObj.relationshipAp  = removeExtraSpaces($('#newEnrolledAssigneeRelationship').val()) //* 7
        newEnrolledObj.workAp          = removeExtraSpaces($('#newEnrolledAssigneeWorkplace').val())
        newEnrolledObj.phoneAp         = removeExtraSpaces($('#newEnrolledAssigneePhone').val())
        newEnrolledObj.emailAp         = removeExtraSpaces($('#newEnrolledAssigneeEmail').val())
        
        // ACADEMICOS
        newEnrolledObj.school          = removeExtraSpaces($('#newEnrolledSchool').val()) //* 8
        newEnrolledObj.statusEgress    = $('#newEnrolledEgress').val() 
        newEnrolledObj.egressRes       = $('#newEnrolledEgressRes').val() 
        newEnrolledObj.beca            = $('#newEnrolledBeca').val() 
        newEnrolledObj.average         = removeExtraSpaces($('#newEnrolledAverage').val()) //* 9
        newEnrolledObj.horary          = $('#newEnrolledHorary').select2('data')[0].text //* 10
        newEnrolledObj.etp             = $('#newEnrolledEtpStatus').val()
        newEnrolledObj.science         = $('#newEnrolledScience').is(':checked') //* 11  
        newEnrolledObj.history         = $('#newEnrolledHistory').is(':checked') //* 11 
        newEnrolledObj.scienceElective = $('#newEnrolledScienceRes').val() || '' // si selecciona ciencias debe seleccionar 1
        
        // MATRICULA
        newEnrolledObj.enrollmentDate  = removeExtraSpaces($('#newEnrolledDate').val()) //* 12
        newEnrolledObj.payDay          = $('#newEnrolledPayDay').val()
        newEnrolledObj.courseType      = $('#newEnrolledCourseType').val()
        newEnrolledObj.payType         = $('#newEnrolledPayType').val()
        newEnrolledObj.yearSelected    = $('#newEnrolledYearSelected').val()

        // DESCUENTOS                   
        newEnrolledObj.discount1       = $('#newEnrolledDiscount').val()
        newEnrolledObj.discount2       = $('#newEnrolledDiscount2').val()
        
        // PAGO
        newEnrolledObj.firstQuota      = $('#newEnrolledFirstQuotaPay').val()
        newEnrolledObj.paymentMethod   = $('#newEnrolledPaymentMethod').val()
        newEnrolledObj.ticket          = removeExtraSpaces($('#newEnrolledTicket').val()) //* 13
        
        if(isRut(newEnrolledObj.rut)) { // 1
            validateCounter++
            $('#newEnrolledRut').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledRut').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar un rut válido.`
        }

        if(newEnrolledObj.birthdate.length > 0) { // 2
            validateCounter++
            $('#newEnrolledBirthdate').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledBirthdate').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar una fecha de nacimiento válida.`
        }

        if(newEnrolledObj.name.length > 0) { // 3
            validateCounter++
            $('#newEnrolledName').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledName').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el nombre del alumno.`
        }

        if(newEnrolledObj.lastname.length > 0) { // 4
            validateCounter++
            $('#newEnrolledLastname').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledLastname').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el apellido paterno del alumno.`
        }

        if(newEnrolledObj.address.length > 0) { // 5
            validateCounter++
            $('#newEnrolledAddress').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledAddress').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar la dirección del alumno.`
        }

        if(newEnrolledObj.nameAp.length > 0) { // 6
            validateCounter++
            $('#newEnrolledAssigneeName').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledAssigneeName').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el nombre completo del apoderado.`
        }

        if(newEnrolledObj.relationshipAp.length > 0) { // 7
            validateCounter++
            $('#newEnrolledAssigneeRelationship').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledAssigneeRelationship').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el parentesco del apoderado con el alumno.`
        }

        if(newEnrolledObj.school.length > 0) { // 8
            validateCounter++
            $('#newEnrolledSchool').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledSchool').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar el nombre del colegio del alumno.`
        }

        if(newEnrolledObj.average.length > 0) { // 9
            validateCounter++
            $('#newEnrolledAverage').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledAverage').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar un promedio de notas válido.`
        }

        if(newEnrolledObj.horary.length > 0) { // 10
            validateCounter++
            $('#newEnrolledHorary').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledHorary').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe seleccionar un horario`
        }
        
        if(newEnrolledObj.science  || newEnrolledObj.history) { // 11
            validateCounter++
            $('#electivesContainer').css({border:'1px solid #3498db'})
        } else {
            $('#electivesContainer').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe seleccionar al menos 1 electivo`
        }

        if(newEnrolledObj.enrollmentDate.length > 0) { // 12
            validateCounter++
            $('#newEnrolledDate').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledDate').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar una fecha de matrícula válida.`
        }
    
        if(newEnrolledObj.ticket.length > 0) { // 13
            validateCounter++
            $('#newEnrolledTicket').css({border:'1px solid #3498db'})
        } else {
            $('#newEnrolledTicket').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar un número de boleta.`
        }

        if(newEnrolledObj.email.length > 0 && !isEmail(newEnrolledObj.email)) { // 13-1
            validateCounter = validateCounter-1
            $('#newEnrolledEmail').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar un correo de alumno válido.`
        } else if(newEnrolledObj.email.length > 0 && isEmail(newEnrolledObj.email)){
            $('#newEnrolledEmail').css({border:'1px solid #3498db'})
        } else if(newEnrolledObj.email.length == 0){
            $('#newEnrolledEmail').css({border:'1px solid #ced4da'})
        }
        
      
        if(newEnrolledObj.emailAp.length > 0 && !isEmail(newEnrolledObj.emailAp)) { // 13-1
            validateCounter = validateCounter-1
            $('#newEnrolledAssigneeEmail').css({border:'1px solid #e74c3c'})
            errMessage += `<br> * Debe ingresar un correo de apoderado válido.`
            console.log('correo apoderado incorrecto')
        } else if(newEnrolledObj.emailAp.length > 0 && isEmail(newEnrolledObj.emailAp)){
            $('#newEnrolledAssigneeEmail').css({border:'1px solid #3498db'})
            console.log('correo apoderado correcto')
        } else if(newEnrolledObj.emailAp.length == 0){
            $('#newEnrolledAssigneeEmail').css({border:'1px solid #ced4da'})
            console.log('sin correo apoderado')
        }
        
        if(validateCounter == 13) {
            $('#errMessages').empty()
            if(chequeStatus == 1) {
                newEnrolledObj.chequeBanco = $('#chequeBanco').val()
                newEnrolledObj.chequeNum   = $('#chequeNum').val()
                newEnrolledObj.chequeMonto = $('#chequeMonto').val()
                newEnrolledObj.chequeFecha = $('#chequeFecha').val()
                let chequeValidateCounter = 0;
                let cheque = {}

                if(newEnrolledObj.chequeBanco.length > 0) { // 1
                    cheque.banco = newEnrolledObj.chequeBanco
                    chequeValidateCounter++
                } else {
                    toastr.warning('Ingrese el nombre del banco del cheque')
                }

                if(newEnrolledObj.chequeNum.length > 0) { // 2
                    cheque.num = newEnrolledObj.chequeNum
                    chequeValidateCounter++
                } else {
                    toastr.warning('Ingrese el número de serie del cheque')
                }

                if(newEnrolledObj.chequeMonto.length > 0) { // 3
                    cheque.monto = newEnrolledObj.chequeMonto
                    chequeValidateCounter++
                } else {
                    toastr.warning('Ingrese el monto del cheque')
                }

                if(newEnrolledObj.chequeFecha.length > 0) { // 4
                    cheque.date = newEnrolledObj.chequeFecha
                    chequeValidateCounter++
                } else {
                    toastr.warning('Ingrese Fecha de pago del cheque')
                }

                if(chequeValidateCounter == 4) {
                    createEnrollment({data: newEnrolledObj, cheque: cheque})
                }
            } else {
                createEnrollment({data: newEnrolledObj})
            }
        } else {
            $('#saveNewEnrolled').attr('disabled', false);

            $('#errMessages').html(`
            <div class="alert alert-dismissible alert-warning">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4 class="alert-heading">Debe solucionar los siguientes errores:</h4>
                <p class="mb-0">${errMessage}</p>
            </div>
            `)
        }

    })

})

function createEnrollment({data, cheque}) {
    swal({
        title: '¿Seguro de matricular al nuevo estudiante?',
        type: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Si, matricular.',
        cancelButtonText: 'No, cancelar.'
    }).then((result) => {
        if (result.value) {
            let sendData = {
                //ALUMNO
                studentRut          :ktoK(cleanRut(data.rut)),
                studentBirthdate    :data.birthdate,
                studentName         :data.name,
                studentLastname     :data.lastname,   
                studentLastname2    :data.lastname2,
                studentEmail        :data.email,
                studentPhone        :data.phone,
                studentAddress      :data.address,
                //APODERADO
                assigneeName        :data.nameAp,
                assigneeRelationship:data.relationshipAp,
                assigneeWork        :data.workAp,
                assigneePhone       :data.phoneAp,
                assigneeEmail       :data.emailAp,
                //ACADEMICOS
                school              :data.school,
                statusEgress        :data.statusEgress,
                egressRes           :data.egressRes,
                beca                :data.beca,
                average             :data.average,
                horary              :data.horary,
                etp                 :data.etp,
                science             :data.science,
                history             :data.history,
                scienceElective     :data.scienceElective,
                //MATRICULA
                enrollmentDate      :data.enrollmentDate,
                payDay              :data.payDay,
                courseType          :data.courseType,
                payType             :data.payType,
                yearSelected        :data.yearSelected,
                //DESCUENTOS
                discount1           :data.discount1,
                discount2           :data.discount2,
                //PAGO
                firstQuota          :data.firstQuota,
                paymentMethod       :data.paymentMethod,
                ticket              :data.ticket,
                //MONTOS
                enrollmentCost      :allValues.valorMatricula,
                QuotasQty           :allValues.cantidadCuotas,
                QuotaCost           :allValues.montoPorCuota,
                totalQuotas         :allValues.totalCuotas,
                totalAmount         :allValues.totalCuotas+allValues.valorMatricula
            }

            if(cheque) {
                sendData.cheque = JSON.stringify(cheque)
            }

            console.log(sendData)
            
            ajax({
                url: '/api/newEnrollment',
                type: 'POST',
                data: sendData 
            }).then(res => {
                console.log(res)
                if(res.ok) {
                    toastr.success('Alumno matriculado correctamente')
                    $('#modalEstudiantes').modal('hide')
                    res.ok._id = rutFunc(res.ok._id)
                    res.ok.numMatricula = res.ok.matricula.numMatricula
                    let newStudentRowAdded = datatableAlumnosEnrolled.row.add(res.ok)
                    .draw()
                    .node()

                    $(newStudentRowAdded).css('color', '#1abc9c')
                    setTimeout(() => {
                        $(newStudentRowAdded).css('color', '#484848')
                    }, 5000);
                } else if(res.err) {
                    $('#saveNewEnrolled').attr('disabled', false);
                    toastr.warning(res.err)
                }
            })      
        } else if(result.dismiss) {
            $('#saveNewEnrolled').attr('disabled', false);
        }
    })
}

$('#observationsEnrolled').on('click', function(){
    observations(alumnosRowSelectedData)
})

$('#observationsRetired').on('click', function(){
    observations(alumnosRowSelectedDataDisabled)
})


function observations(studentData) {
    ajax({
        url:'api/getObservations',
        type: 'POST',
        data: {
            rut: studentData._id
        }
    }).then(res=>{
        let creatingObservationStatus = 0;

        $('#modalEstudiantes').modal();
        $('#modal_title').text(`Observaciones de ${studentData.name} ${studentData.lastname1}`);

        $('#modal_body').html(`
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-dark btn-block" id="newObservation">
                        <i style="color:#3498db;" class="fa fa-plus"></i> Nueva observación
                    </button>
                </div>
                <div class="col-md-6">
                </div>
            </div>
            <div class="row" id="newObservationDiv"></div>
            <br>
            <div class="list-group" id="observationsList"></div>
        `)

        if(res.ok.observations && res.ok.observations.length > 0) {
            let reverseObservations = res.ok.observations.reverse()
            let observationsHTML = reverseObservations.reduce((txt, el, i) => {
                return txt += `
                <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                    <h5>${el.title}</h5>
                    <small>${moment(el.date).format('DD/MM/YYYY hh:mm')}</small>
                    </div>
                    <p class="mb-1">${el.text}</p>      
                </a>
                ` 
            }, '');

            $('#observationsList').append(observationsHTML)
        } else {
            toastr.warning('Este alumno no tiene observaciones')
        }

        $('#newObservation').on('click', function(){
            if(creatingObservationStatus == 0) {
                $('#newObservationDiv').html(`
                <div class="jumbotron col-md-12">
                
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="exampleInputEmail1">Título de la observación</label>
                                <input placeholder="Título de la observación" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" id="newObservationTitle" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-8"></div>
                        
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Observación</label>
                                <textarea placeholder="Texto de la observación" onkeyup="aMays(event, this)" onblur="aMays(event, this)" class="form-control" id="newObservationText" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-12">
                            <button class="btn btn-dark" id="createObservation">
                                <i style="color:#1abc9c;" class="fa fa-plus"></i> Crear observación
                            </button>
                        </div>
                    </div>
                </div>
                `)

                creatingObservationStatus = 1;

                $('#createObservation').on('click', function(){
                    let newObservationTitleValidate = $('#newObservationTitle').val()
                    let newObservationTextValidate = $('#newObservationText').val()
                    
                    let validateCounter = 0;

                    if(newObservationTitleValidate.length > 0) {
                        validateCounter++
                    } else {
                        toastr.warning('Debe agregar un título a la observación')
                    }

                    if(newObservationTextValidate.length > 0) {
                        validateCounter++
                    } else {
                        toastr.warning('Debe agregar texto a la observación')
                    }
                    
                    if(validateCounter == 2) {
                        $('#newObservationDiv').empty() 
                        let creatingObservationStatus = 0;
                        
                        ajax({
                            url: 'api/createObservation',
                            type: 'POST',
                            data: {
                                rut: studentData._id,
                                title: newObservationTitleValidate,
                                text: newObservationTextValidate
                            }
                        }).then(res=> {
                            if(res.ok) {
                                $('#observationsList').prepend(`
                                <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                                    <div class="d-flex w-100 justify-content-between">
                                    <h5>${res.ok.title}</h5>
                                    <small>${moment(res.ok.date).format('DD/MM/YYYY hh:mm')}</small>
                                    </div>
                                    <p class="mb-1">${res.ok.text}</p>      
                                </a>
                                `)

                                $('#createObservation').attr('disabled', false);
                            }
                        })
                    }
                    
                })
            } else {
                $('#newObservationDiv').empty()
                creatingObservationStatus = 0;
            }
            
        })
        
    })
}
 //iniciar select de horarios

$('#closeMatrStudentEnrolled').on('click', function(){
    console.log(alumnosRowSelectedData)
    let estudianteDes = alumnosRowSelectedData._id
    swal({
        title: '¿Estás seguro de cerrar esta matrícula?',
      text: '',
      type: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Cerrar Matrícula',
      cancelButtonText: 'Cancelar',
      confirmButtonClass: 'btn btn-danger',
      cancelButtonClass: 'btn btn-primary',
      buttonsStyling: false
    }).then(function (action) {
        if (action.value) {
            console.log(action)
            ajax({
                url: '/api/deshabilitarAlumno',
                type: 'DELETE',
                data: {
                    estudianteDes
                }
            }).then(res=> {
                if (res.ok) {
                    toastr.success(res.ok); 
                    alumnosRowSelected.remove().draw();
                    disableAll()

                    datatableAlumnosDisabled.row.add(alumnosRowSelectedData).draw();
                }
            })
        }
	});
});
//XXXXXXXXXXXXXXXXXXXXX
//Opciones estudiante
$('#optionStudentEnrolled').on('click', function(){
    opcionesModal(alumnosRowSelectedData);
})

$('#optionStudentRetired').on('click', function(){
    opcionesModal(alumnosRowSelectedDataDisabled);
})

function opcionesModal(studentData) { 
    $('#modalEstudiantes').modal();
    $('#modal_title').text('Opciones');
    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1"><i class="fas fa-align-justify"></i></span>
                    <div class="info-box-content">
                    <span class="info-box-text"><h5><a class="dropdown-item" href="#">Asistencia</a></h5></span>
                   
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1" style="background-color: #23ad67 !important;"><i class="fas fa-book"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text"><h5><a class="dropdown-item" href="#"> Puntajes</a></h5></span>
                        
                    </div>
                </div>
            </div>
        </div>
        </div class="row">
            <div class="col-md-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1" style="background-color: #3498db !important;"><i class="fas fa-book"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text"><h5><a class="dropdown-item"> Documentos del Alumno</a></h5></span>
                        <div class="row">
                            <div class="offset-md-1 col-md-4">
                                <button id="printPDF" type="button" class="btn btn-outline-primary">Ficha matrícula</button>
                            </div>
                            <div class="offset-md-3 col-md-4">
                                <button id="certificadoRegular" type="button" class="btn btn-outline-primary">Alumno regular</button>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
        </div>
       
     `)
    
    $('#certificadoRegular').on('click', function () {
        var doc = new jsPDF();
        doc.setDrawColor(0, 0, 0);
        doc.setFontSize(16);
        doc.setFontType("bold")
        doc.text(66,83,"Certificado de alumno regular");
        doc.line(66, 85, 145, 85);
        doc.addImage(logoCebal, 'JPEG', 20, 40, 40, 15);

        doc.setFontType("normal");
        doc.setFontSize(10);
        doc.text(130,40, moment().format('dddd DD [de] MMMM [de] YYYY'));
        doc.setFontSize(12);
        doc.text(37,100,`   Ricardo Bravo Méndez, rector del centro educacional CEBAL, certifica\nque ${studentData.name} ${studentData.lastname1.trim()} ${studentData.lastname2.trim()}, Rut ${studentData._id} es alumno(a)`);
        doc.text(37,110,`de este centro educacional, en la sede de {{{credentials.place}}}, conforme a matrícula\nN°${studentData.numMatricula}, año ${moment().format('YYYY')}.`);
        doc.text(37,128,`   Se extiende el presente certificado a petición del interesado, para ser\npresentado en el lugar que estime conveniente.`)
        

        doc.setFontSize(14);
        doc.setFontType("bold")
        doc.text(79,250,"Ricardo Bravo Méndez");
        doc.text(95,257,"Director");


        doc.setFontType("italic");
        doc.setFontSize(9);
        if (place==='Curicó'){
            doc.text(35,275,"Dirección: Manuel Montt #358, Curicó - Contacto: contacto@cebal.cl - Fono: 75 2320402 - www.cebal.cl");
        }else if(place==='Parral'){
            doc.text(35,275,"Dirección: Urrutia #405, Parral - Contacto: parral@cebal.cl - Fono: 73 2462307 - www.cebal.cl");
        }else if (place==='Linares'){
            doc.text(35,275,"Dirección: Manuel Rodriguez #315, Linares - Contacto: linares@cebal.cl - Fono: 73 2214675 - www.cebal.cl");
        }
        doc.text(70,280,"Preuniversitario CEBAL - Sólido en P.S.U");

        doc.setFontSize(8)
        doc.setFont('times')
        doc.setFontType('normal')
        doc.setTextColor(100)
        doc.text(35, 290, `Generado por {{{credentials.name}}}`+` {{{credentials.lastname}}}`)
        doc.save(`Certificado alumno regular `+ ` ${studentData.name}.pdf`);
            
    })

    $('#printPDF').on('click', function () {
        var doc = new jsPDF();
        doc.setDrawColor(0, 0, 0);
        doc.setFontSize(16);
        doc.setFontType("bold")
        doc.text(85,50,"Ficha de Matrícula");
        doc.line(85, 52, 134, 52);
        doc.setFontSize(10);
        doc.setFontType("normal");
        doc.text(90,58,"Preuniversitario CEBAL");

        doc.addImage(logoCebal, 'JPEG', 20, 32, 30, 10);
        doc.addImage(perfil, 'JPEG', 150, 42, 40, 40);

        doc.setFontType("bold");
        doc.text(40,78,"N° Matrícula");
        doc.setFontType("normal");
        doc.text(85,78,studentData.numMatricula.toString());

        doc.setFontType("bold");
        doc.text(40,85,"Año");
        doc.setFontType("normal");
        doc.text(85,85,moment(studentData.date).format('YYYY'));
        
        doc.line(40, 88, 134, 88);
        doc.setFontSize(11);
        doc.setFontType("bold");
        doc.text(40,94,"Nombre Completo");
        doc.setFontType("normal");
        doc.text(85,94,studentData.name + " " + studentData.lastname1 + " " + studentData.lastname2);

        doc.setFontType("bold");
        doc.text(40,101,"Rut");
        doc.setFontType("normal");
        doc.text(85,101,rutFunc(studentData._id));

        doc.setFontType("bold");
        doc.text(40,108,"Fecha de nacimiento");
        doc.setFontType("normal");
        doc.text(85,108,studentData.birthday);

        doc.setFontType("bold");
        doc.text(40,115,"Domicilio");
        doc.setFontType("normal");
        doc.text(85,115,studentData.address);
        
        doc.setFontType("bold");
        doc.text(40,122,"Celular");
        doc.setFontType("normal");
        doc.text(85,122,studentData.phone);

        doc.setFontType("bold");
        doc.text(40,129,"Correo");
        doc.setFontType("normal");
        doc.text(85,129,studentData.email);

        doc.setFontType("bold");
        doc.text(40,136,"Colegio");
        doc.setFontType("normal");
        doc.text(85,136,studentData.matricula.colegio);
        
        if(studentData.matricula.estadoEgreso == 'Graduado') {
            doc.setFontType("bold");
            doc.text(40,143,"Año de egreso");
            doc.setFontType("normal");
            doc.text(85,143,studentData.matricula.añoEgreso);
        } else {
            doc.setFontType("bold");
            doc.text(40,143,"Cursando");
            doc.setFontType("normal");
            doc.text(85,143,studentData.matricula.curso);
        }

        

        doc.setFontType("bold");
        doc.text(40,150,"Promedio");
        doc.setFontType("normal");
        doc.text(85,150,studentData.matricula.promedio);

        doc.setFontType("bold");
        doc.text(40,157,"Horario");
        doc.setFontType("normal");
        doc.text(85,157,studentData.matricula.horario);
        
        if(studentData.matricula.electivo == 'Ciencias' && studentData.matricula.electivo2 == 'Historia') { // CIENCIAS Y HISTORIA
            doc.setFontType("bold");
            doc.text(40,164,"Electivos");
            doc.setFontType("normal");
            doc.text(85,164,studentData.matricula.electivo + ": "+studentData.matricula.electivoCiencias+" | "+ studentData.matricula.electivo2);
        } else if(studentData.matricula.electivo == 'Historia' && studentData.matricula.electivo2 == 'Ciencias') { // HISTORIA Y CIENCIAS
            doc.setFontType("bold");
            doc.text(40,164,"Electivos");
            doc.setFontType("normal");
            doc.text(85,164,studentData.matricula.electivo2 + ": "+studentData.matricula.electivoCiencias+" | "+ studentData.matricula.electivo);
        } else if(studentData.matricula.electivo == 'Ciencias' && studentData.matricula.electivo2 == '') { // SOLO CIENCIAS
            doc.setFontType("bold");
            doc.text(40,164,"Electivo");
            doc.setFontType("normal");
            doc.text(85,164,studentData.matricula.electivo + ": "+studentData.matricula.electivoCiencias);
        } else if(studentData.matricula.electivo == 'Historia' && studentData.matricula.electivo2 == '') { // SOLO HISTORIA
            doc.setFontType("bold");
            doc.text(40,164,"Electivo");
            doc.setFontType("normal");
            doc.text(85,164,studentData.matricula.electivo);
        }

        doc.line(40, 168, 134, 168);
        doc.setFontType("bold");
        doc.text(40,174,"Apoderado");
        doc.setFontType("normal");
        doc.text(85,174,studentData.nameAp);

        doc.setFontType("bold");
        doc.text(40,181,"Parentesco");
        doc.setFontType("normal");
        doc.text(85,181,studentData.relationshipAp);

        doc.setFontType("bold");
        doc.text(40,188,"Lugar de trabajo");
        doc.setFontType("normal");
        doc.text(85,188,studentData.workAp);
        
        doc.setFontType("bold");
        doc.text(40,195,"Teléfono apoderado");
        doc.setFontType("normal");
        doc.text(85,195,studentData.phoneAp);

        doc.setFontType("normal");
        doc.line(40, 198, 134, 198);
        doc.setFontType("bold");
        doc.text(40,204,"Fecha matrícula");
        doc.setFontType("normal");
        doc.text(85,204,moment(studentData.date).format('DD/MM/YYYY'));

        doc.setFontType("bold");
        doc.text(40,211,"Tipo de curso");
        doc.setFontType("normal");
        doc.text(85,211,studentData.matricula.tipoCurso);

        doc.setFontType("bold");
        doc.text(40,218,"Forma de pago");
        doc.setFontType("normal");
        doc.text(85,218,studentData.matricula.finance.formaPago);
        
        doc.setFontType("italic");
        doc.setFontSize(9);
        if (place==='Curicó'){
            doc.text(35,275,"Dirección: Manuel Montt #358, Curicó - Contacto: contacto@cebal.cl - Fono: 75 2320402 - www.cebal.cl");
        }else if(place==='Parral'){
            doc.text(35,275,"Dirección: Urrutia #405, Parral - Contacto: parral@cebal.cl - Fono: 73 2462307 - www.cebal.cl");
        }else if (place==='Linares'){
            doc.text(35,275,"Dirección: Manuel Rodriguez #315, Linares - Contacto: linares@cebal.cl - Fono: 73 2214675 - www.cebal.cl");
        }
        
        doc.text(70,280,"Preuniversitario CEBAL - Sólido en P.S.U");
        doc.save(`FichaMatricula `+ ` ${studentData.name}.pdf`);
    })

}
    


$('#pagosEnrolled').on('click', function(){
    pagosModal(alumnosRowSelectedData._id);
})

$('#pagosRetired').on('click', function(){
    pagosModal(alumnosRowSelectedDataDisabled._id);
})

function pagosModal(selected_id) {
    //alumnosRowSelectedDataDisabled
    console.log('enviando pago')
    let cuotasAPagar = []
    let cuotasARemover = []

    ajax({
        url: '/api/getCuotas',
        type: 'POST',
        data:{rut: selected_id}
    }).then(res=>{
        console.log(res)
        let montoTotal = 0
        let chequeStatus = 0

        let listCuotas = res.ok.matricula.finance.cuotas.reduce((txt, el, i)=>{
            let thisList = ''
            
            if(el.status == 'pending') {
                thisList = `
                <div class="col-md-4" style="margin-top:10px;">
                    <a id="cuota_${el.num}" href="#" class="list-group-item list-group-item-action flex-column align-items-start cuotaPay">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${moment(el.payday).format('DD/MM/YYYY')}</h5>
                            <small>Cuota número ${el.num}</small>
                        </div>
                        <p class="mb-1">$ ${number_format(el.amount)}</p>
                        <small>Pendiente</small>
                    </a>
                </div>
                `
            } else if(el.status == 'payed') {
                let ticketPayed = ''
                if(el.ticket) {
                    ticketPayed = `<span>Boleta: <b>${el.ticket}</b></span>`
                }
                thisList = `
                <div class="col-md-4" style="margin-top:10px;">
                    <a href="#" onclick="getTicket('${el.ticket}')" class="list-group-item list-group-item-action flex-column align-items-start active">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${moment(el.payday).format('DD/MM/YYYY')}</h5>
                            <small>Cuota número ${el.num}</small>
                        </div>
                        <p class="mb-1">$ ${number_format(el.amount)}</p>
                        ${ticketPayed}
                        <br>
                        <small>Pagada el ${moment(el.payedDay).format('DD/MM/YYYY')}</small>
                    </a>
                </div>
                `
            } else if(el.status == 'removed') {
                thisList = `
                    <div class="col-md-4" style="margin-top:10px;">
                        <a href="#" class="list-group-item list-group-item-action flex-column align-items-start removedStatus">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${moment(el.payday).format('DD/MM/YYYY')}</h5>
                                <small>Cuota número ${el.num}</small>
                            </div>
                            <p class="mb-1">$ ${number_format(el.amount)}</p>
                            <h4><b>Removida</b></h4>
                            <small>Removida el ${moment(el.removedDay).format('DD/MM/YYYY')}</small>
                        </a>
                    </div>
                `
            }

            return txt += `
                ${thisList}
            `
        }, '') 
        
        let enrollmentTicketPayed = ''
        if(res.ok.matricula.finance.ticketEnrollment) {
            enrollmentTicketPayed = `<span>Boleta: <b>${res.ok.matricula.finance.ticketEnrollment}</b></span>`
        }
        $('#modalEstudiantes').modal();
        $('#modal_title').html('Gestión de cuotas');
        $('#modal_body').html(`
            <div class="card  mb-12" style="max-width: 50rem;">
                <div class="card-header"><h5>Datos estudiante</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fa fa-user"></i> Rut</label>
                            <input type="text" value="${rutFunc(res.ok._id)}"  required class="form-control border-input" readOnly>
                        </div>
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fa fa-user"></i> Nombre</label>
                            <input type="text" value="${res.ok.name} ${res.ok.lastname1}"  required class="form-control border-input" readOnly>
                        </div>
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fa fa-key"></i> Monto matrícula</label>
                            <input type="text" value="${res.ok.matricula.finance.valorMatricula}"  required class="form-control border-input" readOnly>
                        </div>
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fa fa-key"></i> Cantidad total de cuotas</label>
                            <input type="text" value="${res.ok.matricula.finance.numCuotas}"  required class="form-control border-input" readOnly>
                        </div>
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fa fa-key"></i> Valor de cada cuota</label>
                            <input type="text" value="${res.ok.matricula.finance.montoCuota}"  required class="form-control border-input" readOnly>
                        </div>
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fa fa-key"></i> Monto Total cuotas</label>
                            <input type="text" value="${res.ok.matricula.finance.totalCuotas}"  required class="form-control border-input" readOnly>
                        </div>
                        
                    </div>
                </div>
                </div>
            </div>
                    

            <div class="card  mb-12" style="max-width: 50rem;margin-top:10px" >
                <div class="card-header"><h5>Acción : 
                    <span>
                        <label class="radio-inline"> <input type="radio" name="season" id="payQuotaOption" value="pay" checked> Pagar </label>
                        <label class="radio-inline"> <input type="radio" name="season" id="removeQuotaOption" value="remove"> Remover </label>
                    </span>
            
                </h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <a href="#" onclick="getTicket('${res.ok.matricula.finance.ticketEnrollment}')" class="list-group-item list-group-item-action flex-column align-items-start active">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${moment(res.ok.matricula.date).format('DD/MM/YYYY')}</h5>
                                    <small>Matrícula</small>
                                </div>
                                <p class="mb-1">$ ${res.ok.matricula.finance.valorMatricula}</p>
                                ${enrollmentTicketPayed}
                                <br>
                                <small>Pagada</small>
                            </a>
                        </div>
                        ${listCuotas}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6" style="margin-top:10px;">
                            <label style="float:left;"><i class="fa fa-asterisk"></i> Forma de pago *</label>
                            <select class="form-control" id="boletaFormaPago">
                                <option value="cash">Efectivo</option>
                                <option value="check">Cheque</option>
                                <option value="transfer">Transferencia</option>
                            </select> 
                        </div>

                        
                        <div class="col-md-6" style="margin-top:10px"> 
                            <label style="float:left;"><i class="fa fa-asterisk"></i> Número de boleta *</label>
                            <input id="ticket" type="text" value="" placeholder="Debe agregar un número de boleta" class="form-control border-input solo-numero">
                        </div>
                    </div>
                    <div id="ifCheque"></div>
                </div>
                
            </div>
            <div class="col-md-12">
                <div class="row"> 
                    <div class="offset-md-6 col-md-3" style="margin-top:15px;">
                        <button id="cancel" class="btn btn-secondary btn-block"><i style="color:#e74c3c;" class="fas fa-ban"></i> Cancelar</button>
                    </div>
                    <div class="col-md-3" style="margin-top:15px;">
                        <button id="save" class="btn btn-secondary btn-block"><i style="color:#3498db;" class="fas fa-cloud"></i> Guardar</button>
                    </div>
                </div>
            </div>
        `)

        $('.solo-numero').keyup(function (){
            this.value = (this.value + '').replace(/[^0-9]/g, ''); 
        });
        
            $('#cancel').on('click', function () {
                $('#modalEstudiantes').modal('hide')
            })
            //fecha
            $('#initDate').daterangepicker({
            "locale": {
                "format": "DD/MM/YYYY",
                "daysOfWeek": [
                "Dom",
                "Lun",
                "Mar",
                "Mie",
                "Jue",
                "Vie",
                "Sab"
                ],
                "monthNames": [
                "Enero",
                "Febrero",
                "Marzo",
                "Abril",
                "Mayo",
                "Junio",
                "Julio",
                "Agosto",
                "Septiembre",
                "Octubre",
                "Noviembre",
                "Diciembre"
                ],
                "firstDay": 1
            },
            drops: "up",
            singleDatePicker: true,
            showDropdowns: true
        });

        $('.cuotaPay').on('click', function(e){
            
            if($('#payQuotaOption').is(':checked')) {
                
                if(cuotasARemover[0]) {
                    toastr.warning('Solo se puede realizar 1 acción a la vez (pagar o remover)')
                } else {
                    if($('#'+e.currentTarget.id).hasClass('toRemove')) {
                        toastr.warning('Primero debe remover el estado <b>remover</b> de la cuota seleccionada')
                    } else {
                        $('#'+e.currentTarget.id).toggleClass( 'active' )
                        $('#'+e.currentTarget.id).toggleClass( 'actived' )

                        if($('#'+e.currentTarget.id).hasClass('active')) {
                            cuotasAPagar.push(e.currentTarget.id.split('_')[1])
                        } else {
                            if (cuotasAPagar.indexOf(e.currentTarget.id.split('_')[1]) > -1) {
                                cuotasAPagar.splice(cuotasAPagar.indexOf(e.currentTarget.id.split('_')[1]), 1);
                            }
                        }   
                    }
                }

                
            } else if($('#removeQuotaOption').is(':checked')) {

                if(cuotasAPagar[0]) {
                    toastr.warning('Solo se puede realizar 1 acción a la vez (pagar o remover)')
                } else {
                    if($('#'+e.currentTarget.id).hasClass('actived')) {
                        toastr.warning('Primero debe remover el estado <b>pagar</b> de la cuota seleccionada')
                    } else {
                        $('#'+e.currentTarget.id).toggleClass( 'active' )
                        $('#'+e.currentTarget.id).toggleClass( 'toRemove' )

                        if($('#'+e.currentTarget.id).hasClass('active')) {
                            cuotasARemover.push(e.currentTarget.id.split('_')[1])
                        } else {
                            if (cuotasARemover.indexOf(e.currentTarget.id.split('_')[1]) > -1) {
                                cuotasARemover.splice(cuotasARemover.indexOf(e.currentTarget.id.split('_')[1]), 1);
                            }
                        }
                    }
                }
                
            }
            console.log(cuotasAPagar, cuotasARemover)
            
        }) 

        $('#boletaFormaPago').on('change', function(){
            if($(this).val() == 'check') {
                chequeStatus = 1;
                $('#ifCheque').html(`
                    <div class="col-md-12" style="margin-top:10px;">
                        <div class="row">
                            <div class="col-md-6">
                                <label style="float:left;"> Banco *</label>
                                <input id="chequeBanco" type="text" value="" placeholder="Nombre del banco" class="form-control border-input">
                            </div>
                            <div class="col-md-6">
                                <label style="float:left;"> Nº Serie *</label>
                                <input id="chequeNum" type="text" value="" placeholder="Número de serie del cheque" class="form-control border-input">
                            </div>
                            <div class="col-md-6">
                                <label style="float:left;"> Monto cheque *</label>
                                <input id="chequeMonto" type="text" value="" placeholder="Monto del cheque" class="form-control border-input">
                            </div> 
                            <div class="col-md-6">
                                <label style="float:left;"> Fecha pago *</label>
                                <input id="chequeFecha" type="text" value="" placeholder="Fecha de pago del cheque" class="form-control border-input">
                            </div>
                            
                        </div>
                    </div>
                `)
                $('#chequeFecha').daterangepicker({
                    "locale": {
                        "format": "DD/MM/YYYY",
                        "daysOfWeek": [
                        "Dom",
                        "Lun",
                        "Mar",
                        "Mie",
                        "Jue",
                        "Vie",
                        "Sab"
                        ],
                        "monthNames": [
                        "Enero",
                        "Febrero",
                        "Marzo",
                        "Abril",
                        "Mayo",
                        "Junio",
                        "Julio",
                        "Agosto",
                        "Septiembre",
                        "Octubre",
                        "Noviembre",
                        "Diciembre"
                        ],
                        "firstDay": 1
                    },
                    drops: "up",
                    singleDatePicker: true,
                    showDropdowns: true
                });
            } else {
                $('#ifCheque').empty()
                chequeStatus = 0;
            }
        })
        
        $('#save').on('click', function(){
            let ticket = $('#ticket').val();
            let boletaFormaPago = $('#boletaFormaPago').val()
            let boletaFormaPagoES = ''
            if(boletaFormaPago == 'cash'){
                boletaFormaPagoES = 'Efectivo'
            } else if(boletaFormaPago == 'check') {
                boletaFormaPagoES = 'Cheque'
            } else if(boletaFormaPago == 'transfer') {
                boletaFormaPagoES = 'Transferencia'
            }
            $(this).attr('disabled', true);
            console.log(boletaFormaPagoES)

            if(cuotasAPagar[0]) { // falta programar los remover!
                let cheque = {}

                if(chequeStatus == 1) { // si existe cheque
                    let chequeBanco = $('#chequeBanco').val()
                    let chequeNum   = $('#chequeNum').val()
                    let chequeMonto = $('#chequeMonto').val()
                    let chequeFecha = $('#chequeFecha').val()
                    let chequeValidateCounter = 0;

                    if(chequeBanco.length > 0) { // 1
                        cheque.banco = chequeBanco
                        chequeValidateCounter++
                    } else {
                        toastr.warning('Ingrese el nombre del banco del cheque')
                    }

                    if(chequeNum.length > 0) { // 2
                        cheque.num = chequeNum
                        chequeValidateCounter++
                    } else {
                        toastr.warning('Ingrese el número de serie del cheque')
                    }

                    if(chequeMonto.length > 0) { // 3
                        cheque.monto = chequeMonto
                        chequeValidateCounter++
                    } else {
                        toastr.warning('Ingrese el monto del cheque')
                    }

                    if(chequeFecha.length > 0) { // 4
                        cheque.date = chequeFecha
                        chequeValidateCounter++
                    } else {
                        toastr.warning('Ingrese Fecha de pago del cheque')
                    }            
                    
                    if(chequeValidateCounter == 4) {
                        if (ticket == '') {
                            toastr.warning('Debe ingresar un número de boleta para las cuotas a pagar.')
                            $(this).attr('disabled', false);
                        } else {
                            ajax({
                                url: 'api/pagarcuotas',
                                type: 'POST',
                                data: {
                                    rut: res.ok._id,
                                    cuotas: JSON.stringify(cuotasAPagar),
                                    ticket: ticket,
                                    formaPago: boletaFormaPago,
                                    cheque: JSON.stringify(cheque)
                                }
                            }).then(res2=>{
                                if(res2.ok) {
                                    let txtCuotas = cuotasAPagar.reduce((txt, el, i) => {
                                        return txt += `${el}, `
                                    }, '');
                                    
                                    screenLog({
                                        id: 'modal_body',
                                        form: 'Pagar cuotas',
                                        action: `Se han pagado las cuotas ${txtCuotas} del alumno de rut ${rutFunc(res.ok._id)}. Número de boleta: ${ticket} con forma de pago: ${boletaFormaPagoES} en {{credentials.place}}`,
                                        type: 'pagarCuota'
                                    })
                                    
                                    swal({
                                        title: res2.ok,
                                        backdrop: 'static', 
                                        keyboard: false,
                                        text: '',
                                        type: 'success',
                                        timer: 5000
                                    }).then(result => {
                                        $('#modalEstudiantes').modal('hide')
                                    }) 
                                } else if (res2.err) {
                                    toastr.warning(res2.err)
                                    $(this).attr('disabled', false);
                                }
                                
                            })
                        }
                        
                    } else {
                        $('#save').attr('disabled', false);
                    }
                    
                } else { // si no existe cheque
                    if (ticket == '') {
                        toastr.warning('Debe ingresar un número de boleta para las cuotas a pagar.')
                        $(this).attr('disabled', false);
                    } else { 
                        ajax({
                            url: 'api/pagarcuotas',
                            type: 'POST',
                            data: {
                                rut: res.ok._id,
                                cuotas: JSON.stringify(cuotasAPagar),
                                ticket: ticket,
                                formaPago: boletaFormaPago
                            }
                        }).then(res2=>{
                            if(res2.ok) {
                                let txtCuotas = cuotasAPagar.reduce((txt, el, i) => {
                                    return txt += `${el}, `
                                }, '');
                                
                                screenLog({
                                    id: 'modal_body',
                                    form: 'Pagar cuotas',
                                    action: `Se han pagado las cuotas ${txtCuotas} del alumno de rut ${rutFunc(res.ok._id)}. Número de boleta: ${ticket} con forma de pago: ${boletaFormaPagoES} en {{credentials.place}}`,
                                    type: 'pagarCuota'
                                })
                                
                                swal({
                                    title: res2.ok,
                                    backdrop: 'static', 
                                    keyboard: false,
                                    text: '',
                                    type: 'success',
                                    timer: 5000
                                }).then(result => {
                                    $('#modalEstudiantes').modal('hide')
                                }) 
                            } else if (res2.err) {
                                toastr.warning(res2.err)
                                $(this).attr('disabled', false);
                            }
                            
                        })
                    }
                    
                }
            } else if(cuotasARemover[0]) { // remover cuotas
                ajax({
                    url: 'api/removercuotas',
                    type: 'POST',
                    data: {
                        rut: res.ok._id,
                        cuotas: JSON.stringify(cuotasARemover)
                    }
                }).then(res2=>{
                    if(res2.ok) {
                        let txtCuotas = cuotasARemover.reduce((txt, el, i) => {
                            return txt += `${el}, `
                        }, '');
                        
                        screenLog({
                            id: 'modal_body',
                            form: 'Remover cuotas',
                            action: `Se han removido las cuotas ${txtCuotas} del alumno de rut ${rutFunc(res.ok._id)}. en {{credentials.place}}`,
                            type: 'removerCuota'
                        })
                        
                        swal({
                            title: res2.ok,
                            backdrop: 'static', 
                            keyboard: false,
                            text: '',
                            type: 'success',
                            timer: 5000
                        }).then(result => {
                            $('#modalEstudiantes').modal('hide')
                        }) 
                    } else if (res2.err) {
                        toastr.warning(res2.err)
                        $(this).attr('disabled', false);
                    }
                    
                })
            } else {
                toastr.warning('Debe seleccionar al menos una cuota')
                $(this).attr('disabled', false);
            }
                
        }) 
    })
    
};

function getTicket(ticket) {
    $('#ticketView').remove()
    
    ajax({
        url:'api/getTicket',
        type: 'POST',
        data: {ticket}
    }).then(res=> {
        console.log(res)
        if(res.ok) {
            let ifCheque = ''

            let ticketQuotas = res.ok.cuotas.reduce((txt, el, i)=>{
                let numCuotaName = el.num
                if(numCuotaName == 0) {
                    numCuotaName = 'Matrícula'
                }
                return txt += `
                    <tr>
                        <td><h4><center>${numCuotaName}</center></h4></td>
                        <td><h4><center>$ ${number_format(el.monto)}</center></h4></td>
                    </tr>
                `
            }, '') 

            if(res.ok.formaPago == 'Cheque') {
                ifCheque = `
                    <div class="col-md-12">
                        <center><h3><b>Información del cheque</b></h3></center>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <h3 class="card-header"><center>Banco</center></h3>
                            <div class="card-body">
                                <h3><center>${res.ok.cheque.banco}</center></h3>
                            </div>      
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <h3 class="card-header"><center>Número</center></h3>
                            <div class="card-body">
                                <h3><center>${res.ok.cheque.num}</center></h3>
                            </div>      
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <h3 class="card-header"><center>Fecha</center></h3>
                            <div class="card-body">
                                <h3><center>${res.ok.cheque.date}</center></h3>
                            </div>      
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <h3 class="card-header"><center>Monto</center></h3>
                            <div class="card-body">
                                <h3><center>$${number_format(res.ok.cheque.monto)}</center></h3>
                            </div>      
                        </div>
                    </div>
                `
            }

            //$('#modal_title').html(`<button id="goBack" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Volver atrás</button> Boleta N° ${res.ok.numBoleta}`)
            $('#ticketView').remove()
            $('#modal_body').prepend(`
            <div id="ticketView" style="margin-top:20px;">

                <div style="border:1px solid #34495e; border-radius:10px;">
                    <button style="border-radius:10px;" id="closeTicketView" class="btn btn-dark"><i class="fas fa-times"></i></button>
                    <div class="row">
                        <div class="col-md-12">
                            <center><h1>${res.ok.place}</h1></center>       
                        </div>
                        <hr>
                        <div class="col-md-6">
                            <center><h3><b>Número de boleta</b></h3></center>
                            <center><h4>${res.ok.numBoleta}</h4></center>
                            <hr>
                            <center><h3><b>Fecha de creación</b></h3></center>
                            <center><h4>${moment(res.ok._id).format('DD/MM/YYYY')}</h4></center>
                            <hr>
                            <center><h3><b>Monto total</b></h3></center>
                            <center><h4>$ ${number_format(res.ok.monto)}</h4></center>
                            <hr>
                            <center><h3><b>Forma de pago</b></h3></center>
                            <center><h4>${res.ok.formaPago}</h4></center>
                        </div>
                        <div class="col-md-6">
                            <center><h3><b>Cuotas</b></h3></center>
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col"><center>Número de cuota</center></th>
                                        <th scope="col"><center>Monto de cuota</center></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ticketQuotas}
                                </tbody>
                            </table>    
                        </div>
                        ${ifCheque}
                    </div>
                </div>
                <br>
            </div>  
            `)

            $('#closeTicketView').on('click', function() {
                $('#ticketView').remove()
            })
            
            
        } else if(res.err) {
            toastr.warning(res.err)
        }
    })
}

function aMays(e, elemento) {
    tecla=(document.all) ? e.keyCode : e.which; 
    elemento.value = elemento.value.toUpperCase();
}
function aMinus(e, elemento) {
tecla=(document.all) ? e.keyCode : e.which; 
 elemento.value = elemento.value.toLowerCase();
}
</script>
{{/extend}}

