{{!< layout/default}}

{{#extend "css"}}
<style>
.info-box {
    box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    border-radius: .25rem;
    padding: .5rem;
    min-height: 80px;
    background: #fff;
    display: flex!important; 
    margin-top:10px;
    font-size: 20px;
}
.info-box-icon {
    border-radius: .25rem;
    display: block;
    width: 90px;
    text-align: center;
    font-size: 40px;
    color: #fff!important;
}
.btn-warning:disabled {
    color: #fff;
    background-color: #FF7518;
    border-color: #FF7518;
}
.btn-warning {
    color: #fff;
    background-color: #FF7518;
    border-color: #FF7518;
}
.card-header{
    background-color: #9dacea;
    color:#333333;
    padding: 0.2rem 1.25rem;
  }
  
    
.h5{
    margin-bottom: 0rem;
}

.actived {
    background:#1abc9c !important;
    border-color:#16a085 !important;
}

</style>
{{/extend}}

<div class="col-md-12">
        <ul class="nav nav-pills mb-3 nav-justified" id="pills-tab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true">Matriculados</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false">Retirados</a>
            </li>
        </ul>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                <div class="row">
                    <div class="col-md-2 col-xs-12">
                        <br>
                        <button class="btn btn-secondary btn-block" id="pagosEnrolled" disabled>
                            <i style="color:#1abc9c;" class="fa fa-plus"></i> Pagos
                        </button>
                        <button class="btn btn-secondary btn-block" id="modStudentEnrolled" disabled>
                            <i style="color:#f1c40f;" class="fas fa-edit"></i> Modificar
                        </button>
                        <button class="btn btn-dark btn-block" id="optionStudentEnrolled" disabled>
                            <i style="color:#3498db;" class="fas fa-ban"></i> Opciones
                        </button>
                        <button class="btn btn-dark btn-block" id="observationsEnrolled" disabled>
                            <i style="color:#9b59b6;" class="fas fa-list-ul"></i> Observaciones
                        </button>
                        <button class="btn btn-dark btn-block" id="closeMatrStudentEnrolled" disabled>
                            <i style="color:#e74c3c;" class="fas fa-ban"></i> Cerrar Matrícula
                        </button>
                    </div>
                
                    <div class="col-md-10 col-xs-12 box-shadows table-responsive">
                        <table id="tableEnrolledAlumns" class="display nowrap table table-condensed" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Rut</th>
                                    <th>Nombre</th>
                                    <th>Apellidos</th>
                                    <th></th>
                                    <th>Domicilio</th>
                                    <th>E-mail</th>
                                    <th>Celular</th>
                                    <th>Apoderado</th>
                                    <th>Parentesco</th>
                                </tr>
                            </thead>
                        </table>
                        <div id="loadingEnrolled">
                            <center>
                                <i style="color:#3498db;" class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
                                <span class="sr-only">Cargando...</span>
                            </center>
                        </div>
                    </div>
                </div>
        </div>
    
    
        <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
            <div class="container-fluid">
                <div class="tab-content">
                    <div class="tab-pane fade show active" style="margin-left:10px;margin-right:10px" id="#" role="tabpanel" aria-labelledby="enables-tab">
                        <div class="row">
                            <div class="col-md-2 col-xs-12">
                                <br>
                                <button class="btn btn-primary btn-block" id="x" disabled>
                                    <i class="fa fa-plus"></i> Opciones
                                </button>
                                <button class="btn btn-warning btn-block" id="x" disabled>
                                    <i class="fas fa-edit"></i> Modificar
                                </button>
                        
                            </div>
                        
                            <div class="col-md-10 col-xs-12 box-shadows table-responsive">
                                <table id="tableDisabledAlumns" class="display nowrap table table-condensed" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Sede</th>
                                            <th>Rut</th>
                                            <th>Nombre</th>
                                            <th>Apellidos</th>
                                            <th></th>
                                            <th>Domicilio</th>
                                            <th>E-mail</th>
                                            <th>Celular</th>
                                            <th>Apoderado</th>
                                            <th>Parentesco</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div id="loadingDisabled">
                                    <center>
                                        <i style="color:#3498db;" class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
                                        <span class="sr-only">Cargando...</span>
                                    </center>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>

<!-- Modal formato-->
<div class="modal fade" id="modalEstudiantes" tabindex="-1" role="dialog" aria-labelledby="modal_title" style="margin-top: 13px">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="background-color: #ffffff">
            <div class="modal-header" style="background:#333333; color:#fff">
                <h5 class="modal-title" id="modal_title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal_body"></div>
            <div class="modal-footer" id="modal_footer"></div>
        </div>
    </div>
</div>
{{#extend "js"}}
<script src="/public/logoCebalB64/logoCebal.js"></script>
<script src="/public/logoCebalB64/perfilAlumno.js"></script>
<script>
    
let defaultModalHTML = '';
let datatable;
let datatableAlumnosEnrolled;
let alumosRowSelectedData;
let alumnosRowSelected;
let datatableAlumnosDisabled;
let alumosRowSelectedDataDisabled;
let place = '{{{credentials.place}}}';

    jQuery(document).ready(function ($) {
        chargeTableAlumnos();
        chargeTableAlumnosDisabled();
    });
       
    function chargeTableAlumnos() {
        datatableAlumnosEnrolled = $('#tableEnrolledAlumns')
        .DataTable({            
                    "iDisplayLength": 100,
                    "oLanguage": {
                        "sSearch": "Buscar :"
                    },
                    "responsive": true,
                    "columns": [
                        { "data": "numMatricula" },
                        { "data": "_id"},
                        { "data": "name" },
                        { "data": "lastname1"},
                        { "data": "lastname2"},
                        { "data": "address"},
                        { "data": "email"},
                        { "data": "phone"},
                        { "data": "nameAp"},
                        { "data": "relationshipAp"}               
                    ],
                initComplete: function (settings, json) {
                    ajax({
                        url: 'api/studentsEnrolled'
                        
                    }).then(res => {
                        if (res.err) {
                            toastr.warning('No existen Alumnos matriculados')
                        } else if(res.ok) {
                            datatableAlumnosEnrolled.rows.add(res.ok).draw();
                            $('#loadingEnrolled').empty();
                        }      
                    })
                }
        });   
        
     $('#tableEnrolledAlumns tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            $('#pagosEnrolled').prop('disabled', true);
            $('#optionStudentEnrolled').prop('disabled', true);
            $('#modStudentEnrolled').prop('disabled', true);
            $('#closeMatrStudentEnrolled').prop('disabled', true);
            $('#observationsEnrolled').prop('disabled', true);
        } else {
            datatableAlumnosEnrolled.$('tr.selected').removeClass('selected');

            $(this).addClass('selected');
            alumosRowSelectedData = datatableAlumnosEnrolled.row($(this)).data();
            alumnosRowSelected = datatableAlumnosEnrolled.row($(this));   // EDUARDO
            console.log(alumosRowSelectedData)
            $('#pagosEnrolled').prop('disabled', false);
            $('#optionStudentEnrolled').prop('disabled', false);
            $('#modStudentEnrolled').prop('disabled', false);
            $('#closeMatrStudentEnrolled').prop('disabled', false);
            $('#observationsEnrolled').prop('disabled', false);
        }
    });
}

function disableAll() {
    $('#pagosEnrolled').prop('disabled', true);
    $('#optionStudentEnrolled').prop('disabled', true);
    $('#modStudentEnrolled').prop('disabled', true);
    $('#closeMatrStudentEnrolled').prop('disabled', true);
    $('#observationsEnrolled').prop('disabled', true);
}
//DATATABLE FINAL recargar
function reloadTableAlumnosEnrolled() {
        ajax({
            url: 'api/studentsEnrolled'
        }).then(res => {
        if (res.err) {
            toastr.warning('No existen Alumnos')
        } else {
            console.log(res)
            datatableAlumnosEnrolled.clear().draw();
            datatableAlumnosEnrolled.rows.add(res.ok).draw();
            $('#loadingEnrolled').empty();

            }
        })
}


//DATATABLE DISABLED ALUMNOS
function chargeTableAlumnosDisabled() {
    datatableAlumnosDisabled = $('#tableDisabledAlumns')
        .DataTable({            
                    "iDisplayLength": 100,
                    "oLanguage": {
                        "sSearch": "Buscar :"
                    },
                    "responsive": true,
                    "columns": [
                        { "data": "city"},
                        { "data": "_id"},
                        { "data": "name" },
                        { "data": "lastname1"},
                        { "data": "lastname2"},
                        { "data": "address"},
                        { "data": "email"},
                        { "data": "phone"},
                        { "data": "nameAp"},
                        { "data": "relationshipAp"}               
                    ],
                initComplete: function (settings, json) {
                    ajax({
                        url: 'api/studentsDisabled'
                    }).then(res => {
                        if (res.err) {
                           // toastr.warning('No existen Alumnos retirados')
                            $('#loadingDisabled').empty();
                        } else {
                            datatableAlumnosDisabled.rows.add(res).draw();
                            $('#loadingDisabled').empty();
                        }      
                    })
                }
        });   
     $('#tableDisabledAlumns tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        } else {
            datatableAlumnosDisabled.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            alumosRowSelectedDataDisabled = datatableAlumnosDisabled.row($(this)).data();
            console.log(alumosRowSelectedDataDisabled)
        }
    });
}
//DATATABLE FINAL recargar
function reloadTableAlumnosDisabled() {
        ajax({
            url: 'api/studentsDisabled'
        }).then(res => {
            if (res.err) {
                toastr.warning('No existen alumnos matriculados')
            } else {
                datatableAlumnosDisabled.clear().draw();
                datatableAlumnosDisabled.rows.add(res).draw();
            }
        })
}
//XXXXXXXXXX
//CERRAR MATRICULA
//MODIFICAR ESTUDIANTE MATRICULADO
$('#modStudentEnrolled').on('click', function(){
    modificarEstModal()
})

function modificarEstModal() { 
      $('#modalEstudiantes').modal();
      $('#modal_title').text('Modificar Estudiante');
      $('#modal_body').html(`
      <div class="card">
                <div class="card-header"><h5>Datos alumno</h5></div>
                <div class="card-body row">
        
                    <div class="col-md-4">
                        <label style="float:left;"><i class="fa fa-key" aria-hidden="true"></i> Rut </label>
                        <input id="rutModAlumno" value="${alumosRowSelectedData._id}" maxlength="12" type="text"  required class="form-control border-input" disabled >
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="far fa-calendar"></i> Fecha de nacimiento </label>   
                        <input  id="fechaModAlumno"  value="${alumosRowSelectedData.birthday}"   class="form-control" type="text">
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fas fa-map-marker"></i> Ciudad </label>
                        <input id="ciudadModAlumno" type="text"  required class="form-control border-input" value="{{{ credentials.place }}}" readOnly>
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fa fa-user" aria-hidden="true"></i> Nombre </label>
                        <input id="nombreModAlumno" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" value="${alumosRowSelectedData.name}" class="form-control border-input" >
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"> Apellido paterno </label>
                        <input id="apellido1ModAlumno"  value="${alumosRowSelectedData.lastname1}" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" class="form-control border-input" >
                    </div>
                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;">Apellido materno</label>
                        <input id="apellido2ModAlumno"  value="${alumosRowSelectedData.lastname2}" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" class="form-control border-input">
                    </div>

                    
                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fa fa-envelope" aria-hidden="true"></i> Correo</label>
                        <input id="correoModAlumno" type="email" onkeyup="aMinus(event, this)" onblur="aMinus(event, this)" value="${alumosRowSelectedData.email}" aria-describedby="emailHelp" class="form-control border-input">
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fas fa-phone-square"></i> Celular</label>
                        <input id="celularModAlumno" type="text"  value="${alumosRowSelectedData.phone}" class="form-control border-input">
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fa fa-home" aria-hidden="true"></i> Dirección </label>
                        <input id="direccionModAlumno" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" value="${alumosRowSelectedData.address}" class="form-control border-input">
                    </div>
                    <!--
                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fas fa-image"></i> Foto alumno</label>
                        <input type="file" accept="image/*" class="form-control-file" id="matrImage">
                    </div>
                    -->
                </div>
            </div>    

            <div class="card" style="margin-top:3px">
                <div class="card-header"><h5>Datos apoderado</h5></div>
                <div class="card-body row">        

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fas fa-user-tie"></i> Nombre apoderado</label>
                        <input id="nombreApoderadoMod" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" value="${alumosRowSelectedData.nameAp}" class="form-control border-input">
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;">Parentesco </label>
                        <input id="parentescoApoderadoMod" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" value="${alumosRowSelectedData.parentesco}" class="form-control border-input"  >
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fas fa-building"></i> Lugar de trabajo </label>
                        <input id="trabajoApoderadoMod" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" class="form-control border-input" value="${alumosRowSelectedData.workAp}">
                    </div>

                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fas fa-phone-square"></i> Celular</label>
                        <input id="celularApoderadoMod" type="text" class="form-control border-input" value="${alumosRowSelectedData.phoneAp}">
                    </div> 
                    <div class="col-md-4" style="margin-top:3px;">
                        <label style="float:left;"><i class="fa fa-envelope"></i> Correo</label>
                        <input id="correoApoderadoMod" type="email" onkeyup="aMinus(event, this)" onblur="aMinus(event, this)" aria-describedby="emailHelp" class="form-control border-input" value="${alumosRowSelectedData.emailAp}" >
                    </div> 
                </div>
            </div>



            <div class="card" style="margin-top:5px">
                <div class="card-header"><h5>Datos académicos</h5></div>
            <div class="card-body row">
                <div style="padding:5px;"> 
                    <div class="row">
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fas fa-school"></i> Colegio </label>
                            <input id="matrColegio" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" required class="form-control border-input" value="${alumosRowSelectedData.colegio}">
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label><i class="far fa-calendar"></i> Egreso </label>
                                <input id="matrEgreso" type="text"  required class="form-control border-input" value="${alumosRowSelectedData.egreso}" readOnly>
                            </div>  
                        </div>
                        <div class="col-md-4">
                            <label style="float:left;"><i class="fab fa-bimobject"></i> Becado </label>
                            <input id="matrBeca" type="text"  required class="form-control border-input" value="${alumosRowSelectedData.beca}" readOnly>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label><i class="far fa-calendar-check"></i> Año de egreso </label>
                                <input id="matrAñoEgreso" type="text"  required class="form-control border-input" value="${alumosRowSelectedData.añoEgreso}" readOnly>
                            </div>  
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label><i class="fas fa-graduation-cap"></i> Cursando </label>
                                <input id="matrCurso" type="text"  required class="form-control border-input" readOnly value="${alumosRowSelectedData.cursando}" >
                            </div>  
                        </div>
                        <div class="col-md-4">
                            <label><i class="fas fa-book"></i> Promedio </label>
                            <input id="matrPromedio" maxlength="2" type="text" class="form-control border-input solo-numero" value="${alumosRowSelectedData.promedio}" readOnly>
                        </div>


                        <div class="col-md-3">
                            <div class="form-group">
                                <label ><i class="far fa-calendar-alt"></i> Horario</label>
                                <select id="matrHorario">
                                    <option>${alumosRowSelectedData.horario}</option>
                                </select>
                            </div>  
                        </div>
                       

                         <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-graduation-cap"></i>ETP </label>
                                <input id="matrETP" maxlength="2" type="text" class="form-control border-input solo-numero" disabled value="${alumosRowSelectedData.etp}" >
                            </div>  
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-graduation-cap"></i>Prueba electiva</label>
                                <input id="matrElectivo" maxlength="2" type="text" class="form-control border-input solo-numero" value="${alumosRowSelectedData.electivo}" readOnly>
                            </div>  
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label><i class="fas fa-graduation-cap"></i>Prueba electiva 2</label>
                                <input id="matrElectivo2" maxlength="2" type="text" class="form-control border-input solo-numero" value="${alumosRowSelectedData.electivo2}" readOnly>
                            </div>  
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="card" style="margin-top:5px">
        <div class="card-header"><h5>Datos de matrícula</h5></div>
        <div class="card-body row">
            <div style="padding:5px;"> 
                <div class="row">
                    <div class="col-md-3" >
                        <label style="float:left;"><i class="far fa-calendar"></i> Fecha de matrícula </label>
                        <input  id="matrFechaMatricula"  class="form-control" type="text" value="${alumosRowSelectedData.fechaMatricula}" readOnly>
                    </div>
                    <div class="col-md-3">
                        <label><i class="fas fa-book"></i> Día de cobro </label>
                        <input id="matrDiaCobro" type="text" class="form-control border-input solo-numero" value="${alumosRowSelectedData.diacobro}" readOnly>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label><i class="fas fa-graduation-cap"></i> Tipo de curso </label>
                            <input  id="matrTipoCurso"  class="form-control" type="text" value="${alumosRowSelectedData.tipoCurso}" readOnly>
                        </div>  
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label><i class="fas fa-graduation-cap"></i> Forma de pago </label>
                            <input  id="matrFormaPago"  class="form-control" type="text" value="${alumosRowSelectedData.formaP}" readOnly>
                        </div>  
                    </div>
                    
                    <div class="col-md-12">
                        <h4>Descuentos</h4><br>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label><i class="fas fa-graduation-cap"></i> Descuento 1</label>
                                        <input  id="matrDescuento1"  class="form-control" type="text" readOnly value="${alumosRowSelectedData.descuento1}">
                                    </div>
                                    <div class="col-md-6">
                                        <label><i class="fas fa-graduation-cap"></i> Descuento 2</label>
                                        <input  id="matrDescuento2"  class="form-control" type="text" readOnly value="${alumosRowSelectedData.descuento2}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <div class="row"> 
            <div class="offset-md-6 col-md-3" style="margin-top:15px;">
                <button id="cancelarModAlum" class="btn btn-secondary btn-block"><i style="color:#f1c40f;" class="fas fa-ban"></i> Cancelar</button>
            </div>
            <div class="col-md-3" style="margin-top:15px;">
                <button id="modificarAlumnoCebal" class="btn btn-secondary btn-block" ><i style="color:#3498db;" class="fas fa-cloud"></i> Modificar</button>
            </div>
        </div>                       
      `)

let selects = {
    place:[],
    horario: [],
}
ajax({ // cargar horarios
    url:'/api/horariosCebalTraerEnrroled'
    }).then(res => {
        console.log(res)
        selects.place = res.filter(function(el) {
            return el.place == '{{{credentials.place}}}'
        })
        console.log(selects.place)
        let horario = selects.place.reduce((arr, el, i) => {
            return arr.concat({
                id: i,
                text: el.horary
            })   
        }, []);

        $('#matrHorario').select2({
            placeholder:'seleccione',
            width:'100%',
            data: horario
        });
    });  

//cerrar modal editar alumnos
$('#cancelarModAlum').on('click', function(){
    $('#modalEstudiantes').modal('hide')
})
//editar los datos de los alumnos
$('#modificarAlumnoCebal').on('click', function(){
    let id = alumosRowSelectedData._id;
    let birthday   = $('#fechaModAlumno').val();
    let name    = $('#nombreModAlumno').val();
    let lastname1  = $('#apellido1ModAlumno').val();
    let lastname2  = $('#apellido2ModAlumno').val();
    let email     = $('#correoModAlumno').val();
    let phone    = $('#celularModAlumno').val();
    let address  = $('#direccionModAlumno').val();

    let nameAp     = $('#nombreApoderadoMod').val();
    let relationshipAp = $('#parentescoApoderadoMod').val();
    let workAp    = $('#trabajoApoderadoMod').val();
    let phoneAp    = $('#celularApoderadoMod').val();
    let emailAp     = $('#correoApoderadoMod').val();

    let colegio    = $('#matrColegio').val();
    let horario    = $('#matrHorario').select2('data')[0].text;
            ajax({
                url: 'api/modStudentEnrroledCebal',
                type: 'POST',
                data: {
                    id: id,
                    birthday: birthday,
                    name: name,
                    lastname1: lastname1,
                    lastname2: lastname2,
                    email: email,
                    phone: phone,
                    address:  address,
                    nameAp: nameAp,
                    relationshipAp: relationshipAp,
                    workAp: workAp,
                    phoneAp: phoneAp,
                    emailAp: emailAp,
                    colegio: colegio,
                    horario: horario,
                }
            }).then(res => {
                if (res.error) {
                    toastr.error(res.error)
                } else {
                    swal({
                        title: 'Alumno modificado correctamente!',
                        text: res.ok,
                        backdrop: 'static',
                        keyboard: false,
                        type: 'success',
                        timer: 3000
                    }).then(result => {
                        $('#modalEstudiantes').modal('hide')  
                       
                        //location.reload()
                        reloadTableAlumnosEnrolled()
                    })
                }
            })
    })
};

$('#observationsEnrolled').on('click', function(){
    ajax({
        url:'api/getObservations',
        type: 'POST',
        data: {
            rut: alumosRowSelectedData._id
        }
    }).then(res=>{
        let creatingObservationStatus = 0;

        $('#modalEstudiantes').modal();
        $('#modal_title').text(`Observaciones de ${alumosRowSelectedData.name} ${alumosRowSelectedData.lastname1}`);

        $('#modal_body').html(`
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-dark btn-block" id="newObservation">
                        <i style="color:#3498db;" class="fa fa-plus"></i> Nueva observación
                    </button>
                </div>
                <div class="col-md-6">
                </div>
            </div>
            <div class="row" id="newObservationDiv"></div>
            <br>
            <div class="list-group" id="observationsList"></div>
        `)

        if(res.ok.observations && res.ok.observations.length > 0) {
            let reverseObservations = res.ok.observations.reverse()
            let observationsHTML = reverseObservations.reduce((txt, el, i) => {
                return txt += `
                <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                    <h5>${el.title}</h5>
                    <small>${moment(el.date).format('DD/MM/YYYY hh:mm')}</small>
                    </div>
                    <p class="mb-1">${el.text}</p>      
                </a>
                ` 
            }, '');

            $('#observationsList').append(observationsHTML)
        } else {
            toastr.warning('Este alumno no tiene observaciones')
        }

        $('#newObservation').on('click', function(){
            if(creatingObservationStatus == 0) {
                $('#newObservationDiv').html(`
                <div class="jumbotron col-md-12">
                
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="exampleInputEmail1">Título de la observación</label>
                                <input placeholder="Título de la observación" type="text" onkeyup="aMays(event, this)" onblur="aMays(event, this)" id="newObservationTitle" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-8"></div>
                        
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Observación</label>
                                <textarea placeholder="Texto de la observación" onkeyup="aMays(event, this)" onblur="aMays(event, this)" class="form-control" id="newObservationText" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-12">
                            <button class="btn btn-dark" id="createObservation">
                                <i style="color:#1abc9c;" class="fa fa-plus"></i> Crear observación
                            </button>
                        </div>
                    </div>
                </div>
                `)

                creatingObservationStatus = 1;

                $('#createObservation').on('click', function(){
                    let newObservationTitleValidate = $('#newObservationTitle').val()
                    let newObservationTextValidate = $('#newObservationText').val()
                    
                    let validateCounter = 0;

                    if(newObservationTitleValidate.length > 0) {
                        validateCounter++
                    } else {
                        toastr.warning('Debe agregar un título a la observación')
                    }

                    if(newObservationTextValidate.length > 0) {
                        validateCounter++
                    } else {
                        toastr.warning('Debe agregar texto a la observación')
                    }
                    
                    if(validateCounter == 2) {
                        $('#newObservationDiv').empty() 
                        let creatingObservationStatus = 0;
                        
                        ajax({
                            url: 'api/createObservation',
                            type: 'POST',
                            data: {
                                rut: alumosRowSelectedData._id,
                                title: newObservationTitleValidate,
                                text: newObservationTextValidate
                            }
                        }).then(res=> {
                            if(res.ok) {
                                $('#observationsList').prepend(`
                                <a href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                                    <div class="d-flex w-100 justify-content-between">
                                    <h5>${res.ok.title}</h5>
                                    <small>${moment(res.ok.date).format('DD/MM/YYYY hh:mm')}</small>
                                    </div>
                                    <p class="mb-1">${res.ok.text}</p>      
                                </a>
                                `)

                                $('#createObservation').attr('disabled', false);
                            }
                        })
                    }
                    
                })
            } else {
                $('#newObservationDiv').empty()
                creatingObservationStatus = 0;
            }
            
        })
        
    })
})

 //iniciar select de horarios

$('#closeMatrStudentEnrolled').on('click', function(){
    console.log(alumosRowSelectedData)
    let estudianteDes = alumosRowSelectedData._id
    swal({
        title: '¿Estás seguro de cerrar esta matrícula?',
      text: '',
      type: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Cerrar Matrícula',
      cancelButtonText: 'Cancelar',
      confirmButtonClass: 'btn btn-danger',
      cancelButtonClass: 'btn btn-primary',
      buttonsStyling: false
    }).then(function (action) {
        if (action.value) {
            console.log(action)
            ajax({
                url: '/api/deshabilitarAlumno',
                type: 'DELETE',
                data: {
                    estudianteDes
                }
            }).then(res=> {
                if (res.ok) {
                    toastr.success(res.ok); 
                    alumnosRowSelected.remove().draw();
                    disableAll()
                }
            })
        }
	});
});
//XXXXXXXXXXXXXXXXXXXXX
//Opciones estudiante
$('#optionStudentEnrolled').on('click', function(){
    opcionesModal();
})
function opcionesModal() { 
      $('#modalEstudiantes').modal();
      $('#modal_title').text('Opciones');
      $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1"><i class="fas fa-align-justify"></i></span>
                    <div class="info-box-content">
                    <span class="info-box-text"><h5><a class="dropdown-item" href="#">Asistencia</a></h5></span>
                   
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1" style="background-color: #23ad67 !important;"><i class="fas fa-book"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text"><h5><a class="dropdown-item" href="#"> Puntajes</a></h5></span>
                        
                    </div>
                </div>
            </div>
        </div>
        </div class="row">
            <div class="col-md-12">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1" style="background-color: #3498db !important;"><i class="fas fa-book"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text"><h5><a class="dropdown-item"> Documentos del Alumno</a></h5></span>
                        <div class="row">
                            <div class="offset-md-1 col-md-4">
                                <button id="printPDF" type="button" class="btn btn-outline-primary">Ficha matrícula</button>
                            </div>
                            <div class="offset-md-3 col-md-4">
                                <button id="certificadoRegular" type="button" class="btn btn-outline-primary">Alumno regular</button>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
        </div>
       
     `)
    /*
     $('#certificadoMatr').on('click', function () {

         defaultModalHTML = $('#modal_body').html()
         $('#modal_body').empty()
      
        $('#modal_body').html(`
        <div class="row"> 
            <div class="col-md-3" style="margin-top:15px;">
                <button id="Atrás" class="btn btn-danger btn-block"><i class="fas fa-ban"></i> Atrás</button>
            </div>
            <div class="col-md-3" style="margin-top:15px;">
                <button id="printPDF" class="btn btn-primary btn-block"><i class="fas fa-cloud"></i> Imprimir</button>
            </div>

            <div class="col-md-12" id="matriculaImprimir" style="margin-top:20px">
                <div class="row">
                    <div class="col-md-2 col-xs-12">
                        <img class="card-img-top" src="/public/img/logo.png" width:"100%">
                    </div>
                <div class="offset-md-2 col-md-4">
                        <label><h5><u>Ficha de Matrícula</u></h5></label><br>
                        <label> Preuniversitario CEBAL </label>  
                    </div> 
                    <div class="col-md-2 col-xs-12">
                        <img class="card-img-top" src="/public/img/carnet2.jpeg" width:"100%">
                    </div>
                </div>
                <div class="row" style="margin-top:-30px;">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                        <label><b> Nombre completo</b></label>
                    </div>
                    <div class="col-md-5 col-sm-6">
                        <label>${alumosRowSelectedData.name + " " + alumosRowSelectedData.lastname1 + " " + alumosRowSelectedData.lastname2}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                        <label><b> Rut</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData._id}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                        <label><b> Fecha de nacimiento</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                        <label>${alumosRowSelectedData.birthday}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                        <label><b> Domicilio</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.address}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                        <label><b> Celular</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                        <label>${alumosRowSelectedData.phone}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                        <label><b> Correo</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.email}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Colegio</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.colegio}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Año de egreso</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.añoEgreso}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                        <label><b> Promedio</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.promedio}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Horario</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.horario}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Prueba optativa</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.electivo}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Apoderado</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.apoderado}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Parentesco</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.parentesco}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Lugar de trabajo</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.workAp}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Celular apoderado</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.phoneAp}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Fecha de matrícula</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.date}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Tipo de curso</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.tipoCurso}</label>
                    </div>
                </div>
                <div class="row">
                    <div class="offset-md-2 col-md-3 col-sm-6">
                            <label><b> Forma de pago</b></label>
                    </div>
                    <div class="col-md-6 col-sm-6">
                         <label>${alumosRowSelectedData.formaP}</label>
                    </div>
                </div><br><br>
                <div class="row">
                    <div class="offset-md-1 col-md-11 col-sm-11">
                        <center><label>Dirección: Manuel Montt #358 - Contacto: contacto@cebal.cl - Fono: 75 2320402 - www.cebal.cl</label>
                        <label>CEBAL Sólido eN P.S.U</label></center>
                        </div>
                </div>
            </div>
        </div>
            `)
        $('#Atrás').on('click', function () {
            $('#modal_body').html(defaultModalHTML)
        })
*/  
$('#certificadoRegular').on('click', function () {
            var doc = new jsPDF();
            doc.setDrawColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFontType("bold")
            doc.text(66,83,"Certificado de alumno regular");
            doc.line(66, 85, 145, 85);
            doc.addImage(logoCebal, 'JPEG', 20, 40, 40, 15);

            doc.setFontType("normal");
            doc.setFontSize(10);
            doc.text(130,40, moment().format('dddd DD [de] MMMM [de] YYYY'));
            doc.setFontSize(12);
            doc.text(37,100,`   Ricardo Bravo Méndez, rector del centro educacional CEBAL, certifica\nque ${alumosRowSelectedData.name} `+ `${alumosRowSelectedData.lastname1} `+`${alumosRowSelectedData.lastname2} `+`,Rut `+`${alumosRowSelectedData._id}`+` es alumno(a)`);
            doc.text(37,110,`de este centro educacional, en la sede de {{{credentials.place}}}, conforme a matrícula\nN°${alumosRowSelectedData.numMatricula}`+`, año `+moment().format('YYYY'));
            doc.text(37,128,`   Se extiende el presente certificado a petición del interesado, para ser\npresentado en el lugar que estime conveniente.`)
            

            doc.setFontSize(14);
            doc.setFontType("bold")
            doc.text(79,250,"Ricardo Bravo Méndez");
            doc.text(95,257,"Director");


            doc.setFontType("italic");
            doc.setFontSize(9);
            if (place==='Curicó'){
                doc.text(35,275,"Dirección: Manuel Montt #358, Curicó - Contacto: contacto@cebal.cl - Fono: 75 2320402 - www.cebal.cl");
            }else if(place==='Parral'){
                doc.text(35,275,"Dirección: Urrutia #405, Parral - Contacto: parral@cebal.cl - Fono: 73 2462307 - www.cebal.cl");
            }else if (place==='Linares'){
                doc.text(35,275,"Dirección: Manuel Rodriguez #315, Linares - Contacto: linares@cebal.cl - Fono: 73 2214675 - www.cebal.cl");
            }
            doc.text(70,280,"Preuniversitario CEBAL - Sólido en P.S.U");

            doc.setFontSize(8)
            doc.setFont('times')
            doc.setFontType('normal')
            doc.setTextColor(100)
            doc.text(35, 290, `Generado por {{{credentials.name}}}`+` {{{credentials.lastname}}}`)
            doc.save(`Certificado alumno regular `+ ` ${alumosRowSelectedData.name}.pdf`);
        
        })


        

        $('#printPDF').on('click', function () {
            var doc = new jsPDF();
            doc.setDrawColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFontType("bold")
            doc.text(85,50,"Ficha de Matrícula");
            doc.line(85, 52, 134, 52);
            doc.setFontSize(10);
            doc.setFontType("normal");
            doc.text(90,58,"Preuniversitario CEBAL");

            doc.addImage(logoCebal, 'JPEG', 20, 32, 30, 10);
            doc.addImage(perfil, 'JPEG', 150, 42, 40, 40);

            doc.setFontType("bold");
            doc.text(40,78,"N° Matrícula");
            doc.setFontType("normal");
            doc.text(85,78,alumosRowSelectedData.numMatricula.toString());

            doc.setFontType("bold");
            doc.text(40,85,"Año");
            doc.setFontType("normal");
            doc.text(85,85,moment(alumosRowSelectedData.date).format('YYYY'));
            
            doc.line(40, 88, 134, 88);
            doc.setFontSize(11);
            doc.setFontType("bold");
            doc.text(40,94,"Nombre Completo");
            doc.setFontType("normal");
            doc.text(85,94,alumosRowSelectedData.name + " " + alumosRowSelectedData.lastname1 + " " + alumosRowSelectedData.lastname2);

            doc.setFontType("bold");
            doc.text(40,101,"Rut");
            doc.setFontType("normal");
            doc.text(85,101,alumosRowSelectedData._id);

            doc.setFontType("bold");
            doc.text(40,108,"Fecha de nacimiento");
            doc.setFontType("normal");
            doc.text(85,108,alumosRowSelectedData.birthday);

            doc.setFontType("bold");
            doc.text(40,115,"Domicilio");
            doc.setFontType("normal");
            doc.text(85,115,alumosRowSelectedData.address);
            
            doc.setFontType("bold");
            doc.text(40,122,"Celular");
            doc.setFontType("normal");
            doc.text(85,122,alumosRowSelectedData.phone);

            doc.setFontType("bold");
            doc.text(40,129,"Correo");
            doc.setFontType("normal");
            doc.text(85,129,alumosRowSelectedData.email);

            doc.setFontType("bold");
            doc.text(40,136,"Colegio");
            doc.setFontType("normal");
            doc.text(85,136,alumosRowSelectedData.colegio);

            doc.setFontType("bold");
            doc.text(40,143,"Año de egreso");
            doc.setFontType("normal");
            doc.text(85,143,alumosRowSelectedData.añoEgreso);

            doc.setFontType("bold");
            doc.text(40,150,"Promedio");
            doc.setFontType("normal");
            doc.text(85,150,alumosRowSelectedData.promedio);

            doc.setFontType("bold");
            doc.text(40,157,"Horario");
            doc.setFontType("normal");
            doc.text(85,157,alumosRowSelectedData.horario);

            doc.setFontType("bold");
            doc.text(40,164,"Prueba optativa");
            doc.setFontType("normal");
            doc.text(85,164,alumosRowSelectedData.electivo);

            doc.line(40, 168, 134, 168);
            doc.setFontType("bold");
            doc.text(40,174,"Apoderado");
            doc.setFontType("normal");
            doc.text(85,174,alumosRowSelectedData.apoderado);

            doc.setFontType("bold");
            doc.text(40,181,"Parentesco");
            doc.setFontType("normal");
            doc.text(85,181,alumosRowSelectedData.parentesco);

            doc.setFontType("bold");
            doc.text(40,188,"Lugar de trabajo");
            doc.setFontType("normal");
            doc.text(85,188,alumosRowSelectedData.workAp);
            
            doc.setFontType("bold");
            doc.text(40,195,"Celular apoderado");
            doc.setFontType("normal");
            doc.text(85,195,alumosRowSelectedData.phoneAp);

            doc.setFontType("normal");
            doc.line(40, 198, 134, 198);
            doc.setFontType("bold");
            doc.text(40,204,"Fecha matrícula");
            doc.setFontType("normal");
            doc.text(85,204,moment(alumosRowSelectedData.date).format('DD/MM/YYYY'));

            doc.setFontType("bold");
            doc.text(40,211,"Tipo de curso");
            doc.setFontType("normal");
            doc.text(85,211,alumosRowSelectedData.tipoCurso);

            doc.setFontType("bold");
            doc.text(40,218,"Forma de pago");
            doc.setFontType("normal");
            doc.text(85,218,alumosRowSelectedData.formaP);
            
            doc.setFontType("italic");
            doc.setFontSize(9);
            if (place==='Curicó'){
                doc.text(35,275,"Dirección: Manuel Montt #358, Curicó - Contacto: contacto@cebal.cl - Fono: 75 2320402 - www.cebal.cl");
            }else if(place==='Parral'){
                doc.text(35,275,"Dirección: Urrutia #405, Parral - Contacto: parral@cebal.cl - Fono: 73 2462307 - www.cebal.cl");
            }else if (place==='Linares'){
                doc.text(35,275,"Dirección: Manuel Rodriguez #315, Linares - Contacto: linares@cebal.cl - Fono: 73 2214675 - www.cebal.cl");
            }
           
            doc.text(70,280,"Preuniversitario CEBAL - Sólido en P.S.U");
            doc.save(`FichaMatricula `+ ` ${alumosRowSelectedData.name}.pdf`);
        })

     }
    


    $('#pagosEnrolled').on('click', function(){
        pagosModal();
    })

    function pagosModal() {
        console.log('enviando pago')
        let cuotasAPagar = []
        ajax({
            url: '/api/getCuotas',
            type: 'POST',
            data:{rut: alumosRowSelectedData._id}
        }).then(res=>{
            console.log(res)
            let maxCuotas = alumosRowSelectedData.numCuotas
            let montoTotal = 0
            let chequeStatus = 0

            let listCuotas = res.ok.matricula.finance.cuotas.reduce((txt, el, i)=>{
                let thisList = ''
                
                if(el.status == 'pending') {
                    thisList = `
                    <div class="col-md-4" style="margin-top:10px;">
                        <a id="cuota_${el.num}" href="#" class="list-group-item list-group-item-action flex-column align-items-start cuotaPay">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${moment(el.payday).format('DD/MM/YYYY')}</h5>
                                <small>Cuota número ${el.num}</small>
                            </div>
                            <p class="mb-1">$ ${number_format(el.amount)}</p>
                            <small>Pendiente</small>
                        </a>
                    </div>
                    `
                } else if(el.status == 'payed') {
                    thisList = `
                    <div class="col-md-4" style="margin-top:10px;">
                        <a href="#" class="list-group-item list-group-item-action flex-column align-items-start active">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${moment(el.payday).format('DD/MM/YYYY')}</h5>
                                <small>Cuota número ${el.num}</small>
                            </div>
                            <p class="mb-1">$ ${number_format(el.amount)}</p>
                            <small>Pagada el ${moment(el.payedDay).format('DD/MM/YYYY')}</small>
                        </a>
                    </div>
                    `
                }
                return txt += `
                    ${thisList}
                `
            }, '') 

            $('#modalEstudiantes').modal();
            $('#modal_title').text('Pago de cuotas');
            $('#modal_body').html(`
                <div class="card  mb-12" style="max-width: 50rem;">
                    <div class="card-header"><h5>Datos estudiante</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label style="float:left;"><i class="fa fa-user"></i> Rut</label>
                                <input type="text" value="${rutFunc(res.ok._id)}"  required class="form-control border-input" readOnly>
                            </div>
                            <div class="col-md-4">
                                <label style="float:left;"><i class="fa fa-user"></i> Nombre</label>
                                <input type="text" value="${res.ok.name} ${res.ok.lastname1}"  required class="form-control border-input" readOnly>
                            </div>
                            <div class="col-md-4">
                                <label style="float:left;"><i class="fa fa-key"></i> Monto matrícula</label>
                                <input type="text" value="${res.ok.matricula.finance.valorMatricula}"  required class="form-control border-input" readOnly>
                            </div>
                            <div class="col-md-4">
                                <label style="float:left;"><i class="fa fa-key"></i> Cantidad total de cuotas</label>
                                <input type="text" value="${res.ok.matricula.finance.numCuotas}"  required class="form-control border-input" readOnly>
                            </div>
                            <div class="col-md-4">
                                <label style="float:left;"><i class="fa fa-key"></i> Valor de cada cuota</label>
                                <input type="text" value="${res.ok.matricula.finance.montoCuota}"  required class="form-control border-input" readOnly>
                            </div>
                            <div class="col-md-4">
                                <label style="float:left;"><i class="fa fa-key"></i> Monto Total cuotas</label>
                                <input type="text" value="${res.ok.matricula.finance.totalCuotas}"  required class="form-control border-input" readOnly>
                            </div>
                            
                        </div>
                    </div>
                    </div>
                </div>
                        

                <div class="card  mb-12" style="max-width: 50rem;margin-top:10px" >
                    <div class="card-header"><h5>Cancelación de cuotas</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <a href="#" class="list-group-item list-group-item-action flex-column align-items-start active">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">${moment(res.ok.matricula.date).format('DD/MM/YYYY')}</h5>
                                        <small>Matrícula</small>
                                    </div>
                                    <p class="mb-1">$ ${res.ok.matricula.finance.valorMatricula}</p>
                                    <small>Pagada</small>
                                </a>
                            </div>
                            ${listCuotas}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6" style="margin-top:10px;">
                                <label style="float:left;"><i class="fa fa-asterisk"></i> Forma de pago *</label>
                                <select class="form-control" id="boletaFormaPago">
                                    <option>Efectivo</option>
                                    <option>Cheque</option>
                                    <option>Transferencia</option>
                                </select> 
                            </div>
    
                            
                            <div class="col-md-6" style="margin-top:10px"> 
                                <label style="float:left;"><i class="fa fa-asterisk"></i> Número de boleta *</label>
                                <input id="ticket" type="text" value="" placeholder="Debe agregar un número de boleta" class="form-control border-input solo-numero">
                            </div>
                        </div>
                        <div id="ifCheque"></div>
                    </div>
                    
                </div>
                <div class="col-md-12">
                    <div class="row"> 
                        <div class="offset-md-6 col-md-3" style="margin-top:15px;">
                            <button id="cancel" class="btn btn-secondary btn-block"><i style="color:#e74c3c;" class="fas fa-ban"></i> Cancelar</button>
                        </div>
                        <div class="col-md-3" style="margin-top:15px;">
                            <button id="save" class="btn btn-secondary btn-block"><i style="color:#3498db;" class="fas fa-cloud"></i> Guardar</button>
                        </div>
                    </div>
                </div>
            `)

            $('.solo-numero').keyup(function (){
                this.value = (this.value + '').replace(/[^0-9]/g, ''); 
            });
          
                $('#cancel').on('click', function () {
                    $('#modalEstudiantes').modal('hide')
                })
                //fecha
                $('#initDate').daterangepicker({
                "locale": {
                    "format": "DD/MM/YYYY",
                    "daysOfWeek": [
                    "Dom",
                    "Lun",
                    "Mar",
                    "Mie",
                    "Jue",
                    "Vie",
                    "Sab"
                    ],
                    "monthNames": [
                    "Enero",
                    "Febrero",
                    "Marzo",
                    "Abril",
                    "Mayo",
                    "Junio",
                    "Julio",
                    "Agosto",
                    "Septiembre",
                    "Octubre",
                    "Noviembre",
                    "Diciembre"
                    ],
                    "firstDay": 1
                },
                drops: "up",
                singleDatePicker: true,
                showDropdowns: true
            });

            $('.cuotaPay').on('click', function(e){
                $('#'+e.currentTarget.id).toggleClass( 'active' )
                $('#'+e.currentTarget.id).toggleClass( 'actived' )

                if($('#'+e.currentTarget.id).hasClass('active')) {
                    cuotasAPagar.push(e.currentTarget.id.split('_')[1])
                } else {
                    if (cuotasAPagar.indexOf(e.currentTarget.id.split('_')[1]) > -1) {
                        cuotasAPagar.splice(cuotasAPagar.indexOf(e.currentTarget.id.split('_')[1]), 1);
                    }
                }
            }) 

            $('#boletaFormaPago').on('change', function(){
                if($(this).val() == 'Cheque') {
                    chequeStatus = 1;
                    $('#ifCheque').html(`
                        <div class="col-md-12" style="margin-top:10px;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label style="float:left;"> Banco *</label>
                                    <input id="chequeBanco" type="text" value="" placeholder="Nombre del banco" class="form-control border-input">
                                </div>
                                <div class="col-md-6">
                                    <label style="float:left;"> Nº Serie *</label>
                                    <input id="chequeNum" type="text" value="" placeholder="Número de serie del cheque" class="form-control border-input">
                                </div>
                                <div class="col-md-6">
                                    <label style="float:left;"> Monto cheque *</label>
                                    <input id="chequeMonto" type="text" value="" placeholder="Monto del cheque" class="form-control border-input">
                                </div> 
                                <div class="col-md-6">
                                    <label style="float:left;"> Fecha pago *</label>
                                    <input id="chequeFecha" type="text" value="" placeholder="Fecha de pago del cheque" class="form-control border-input">
                                </div>
                                
                            </div>
                        </div>
                    `)
                    $('#chequeFecha').daterangepicker({
                        "locale": {
                            "format": "DD/MM/YYYY",
                            "daysOfWeek": [
                            "Dom",
                            "Lun",
                            "Mar",
                            "Mie",
                            "Jue",
                            "Vie",
                            "Sab"
                            ],
                            "monthNames": [
                            "Enero",
                            "Febrero",
                            "Marzo",
                            "Abril",
                            "Mayo",
                            "Junio",
                            "Julio",
                            "Agosto",
                            "Septiembre",
                            "Octubre",
                            "Noviembre",
                            "Diciembre"
                            ],
                            "firstDay": 1
                        },
                        drops: "up",
                        singleDatePicker: true,
                        showDropdowns: true
                    });
                } else {
                    $('#ifCheque').empty()
                    chequeStatus = 0;
                }
            })
            
            $('#save').on('click', function(){
                let ticket = $('#ticket').val();
                let boletaFormaPago = $('#boletaFormaPago').val()
                $(this).attr('disabled', true);
                console.log(boletaFormaPago)

                if (ticket == '') {
                    toastr.warning('Debe ingresar un número de boleta.')
                    $(this).attr('disabled', false);
                } else {
                    if(cuotasAPagar[0]) {
                        let cheque = {}

                        if(chequeStatus == 1) {
                            let chequeBanco = $('#chequeBanco').val()
                            let chequeNum   = $('#chequeNum').val()
                            let chequeMonto = $('#chequeMonto').val()
                            let chequeFecha = $('#chequeFecha').val()
                            let chequeValidateCounter = 0;

                            if(chequeBanco.length > 0) { // 1
                                cheque.banco = chequeBanco
                                chequeValidateCounter++
                            } else {
                                toastr.warning('Ingrese el nombre del banco del cheque')
                            }

                            if(chequeNum.length > 0) { // 2
                                cheque.num = chequeNum
                                chequeValidateCounter++
                            } else {
                                toastr.warning('Ingrese el número de serie del cheque')
                            }

                            if(chequeMonto.length > 0) { // 3
                                cheque.monto = chequeMonto
                                chequeValidateCounter++
                            } else {
                                toastr.warning('Ingrese el monto del cheque')
                            }

                            if(chequeFecha.length > 0) { // 4
                                cheque.date = chequeFecha
                                chequeValidateCounter++
                            } else {
                                toastr.warning('Ingrese Fecha de pago del cheque')
                            }            
                            
                            if(chequeValidateCounter == 4) {
                                ajax({
                                    url: 'api/pagarcuotas',
                                    type: 'POST',
                                    data: {
                                        rut: res.ok._id,
                                        cuotas: JSON.stringify(cuotasAPagar),
                                        ticket: ticket,
                                        formaPago: boletaFormaPago,
                                        cheque: JSON.stringify(cheque)
                                    }
                                }).then(res2=>{
                                    if(res2.ok) {
                                        let txtCuotas = cuotasAPagar.reduce((txt, el, i) => {
                                            return txt += `${el}, `
                                        }, '');
                                        
                                        screenLog({
                                            id: 'modal_body',
                                            form: 'Pagar cuotas',
                                            action: `Se han pagado las cuotas ${txtCuotas} del alumno de rut ${rutFunc(res.ok._id)}. Número de boleta: ${ticket} con forma de pago: ${boletaFormaPago} en {{credentials.place}}`,
                                            type: 'pagarCuota'
                                        })
                                        
                                        swal({
                                            title: res2.ok,
                                            backdrop: 'static', 
                                            keyboard: false,
                                            text: '',
                                            type: 'success',
                                            timer: 5000
                                        }).then(result => {
                                            $('#modalEstudiantes').modal('hide')
                                        }) 
                                    } else if (res2.err) {
                                        toastr.warning(res2.err)
                                        $(this).attr('disabled', false);
                                    }
                                    
                                })
                            } else {
                                $('#save').attr('disabled', false);
                            }
                            
                        } else {
                            ajax({
                                url: 'api/pagarcuotas',
                                type: 'POST',
                                data: {
                                    rut: res.ok._id,
                                    cuotas: JSON.stringify(cuotasAPagar),
                                    ticket: ticket,
                                    formaPago: boletaFormaPago
                                }
                            }).then(res2=>{
                                if(res2.ok) {
                                    let txtCuotas = cuotasAPagar.reduce((txt, el, i) => {
                                        return txt += `${el}, `
                                    }, '');
                                    
                                    screenLog({
                                        id: 'modal_body',
                                        form: 'Pagar cuotas',
                                        action: `Se han pagado las cuotas ${txtCuotas} del alumno de rut ${rutFunc(res.ok._id)}. Número de boleta: ${ticket} con forma de pago: ${boletaFormaPago} en {{credentials.place}}`,
                                        type: 'pagarCuota'
                                    })
                                    
                                    swal({
                                        title: res2.ok,
                                        backdrop: 'static', 
                                        keyboard: false,
                                        text: '',
                                        type: 'success',
                                        timer: 5000
                                    }).then(result => {
                                        $('#modalEstudiantes').modal('hide')
                                    }) 
                                } else if (res2.err) {
                                    toastr.warning(res2.err)
                                    $(this).attr('disabled', false);
                                }
                                
                            })
                        }

                        
                    }else {
                        toastr.warning('Debe seleccionar al menos una cuota a pagar')
                        $(this).attr('disabled', false);
                    }
                }
                   
                
                
            }) 
        })
        
    };

function aMays(e, elemento) {
    tecla=(document.all) ? e.keyCode : e.which; 
    elemento.value = elemento.value.toUpperCase();
}
function aMinus(e, elemento) {
tecla=(document.all) ? e.keyCode : e.which; 
 elemento.value = elemento.value.toLowerCase();
}
</script>
{{/extend}}

